---
title: "Bilingualism in Canada: Geographic Distribution Tables"
author: Esther Schott (esther.schott@mail.concordia.ca)
output: html_document
---
output: 
  html_document: 
    code_folding: show
    collapsed: no
    df_print: kable
    highlight: espresso
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\\\
# load libraries
```{r load packages}
#install.packages("gpclib", type="source")

library(tidyverse)
library(rgeos)
library(rgdal)
library(maptools)
library(sp)
library(here)
library(fuzzyjoin)
library(viridis)
library(scales)
library(ggrepel)
library(rio)
library(tidylog)
```





# process census language data
## load census language data
```{r read_census_data}
idata_child = import(file = here::here("03_output","00_processed_data", "idata_preprocessed.Rdata"))
age_groups_of_interest = c("0 to 4 years", "5 to 6 years", "7 to 9 years")


child_0_4_data = idata_child %>%  filter(age_group == "0 to 4 years") 

```

# look only at children 0-4
## summarize census language data by area & province
```{r summarize_census_data}
(gma_LangGroup_data = child_0_4_data %>%
  group_by(province,area,n_languages) %>%
  summarize(N=n()) %>%
    mutate( Percent = round(N/sum(N),2)) %>% 
    filter(n_languages == "Two or more") ) %>%
  ungroup
    

```
## table 1: detailed age breakdown
### prep
```{r}
data_table2 = idata_child %>%
  filter(age_group %in% age_groups_of_interest) %>%
  mutate(age_collapsed = fct_collapse(age_group, 
                      "age_0_to_4" = "0 to 4 years",
                      "age_5_to_9" = c("5 to 6 years", "7 to 9 years"))) %>%
  select(province, area, age_group, age_collapsed, n_languages, lang_pair, sex, person_id)

```

### province-wide

xxx decide what to do with missing values
```{r}


# calculate province-wide breakdown
table_prov = data_table2 %>%
  group_by(province, age_collapsed) %>%
  mutate(total_for_area_and_age = n()) %>% 
  group_by(province, age_collapsed, total_for_area_and_age, n_languages) %>%
  summarize(N=n()) %>% 
    mutate( Percent = N/total_for_area_and_age)%>% 
    filter(n_languages != "One Language")  %>%
  select(-n_languages) %>%
  rename(N_bilingual = N) %>%
  mutate(area = "") %>%
  ungroup()

# convert to wide data for displaying in paper
table_prov_wide = table_prov %>% 
  select(-total_for_area_and_age) %>%
  pivot_wider(names_from = age_collapsed, 
              values_from = c(Percent, N_bilingual))
```
### province-wide combined across ages
```{r}
table_prov_0_9 = table_prov %>% 
  group_by(province) %>%
  summarise(Percent_age_0_to_9 = sum(N_bilingual)/sum(total_for_area_and_age))
 
```
### combine province-wide data
```{r}

table_prov_combined = table_prov_wide %>% select(-starts_with("N_biling")) %>%
  full_join(table_prov_0_9)
```



### canada-wide
#### by age subgroup & combined
```{r}



# calculate bilingualism % for all of Canada, to merge into table later
total_across_canada = table_prov %>%
  group_by( age_collapsed) %>%
  summarize(total= sum(total_for_area_and_age),
            N_bilingual = sum(N_bilingual)) %>% # need this intermediate step to be able to calculate combined column 0-9
  mutate(Percent = N_bilingual/total,
         country = "Canada") %>% 
  pivot_wider(names_from = "age_collapsed", values_from = c("total", "N_bilingual", "Percent")) %>% # to be able to add a column on 0 to 9
  mutate(Percent_age_0_to_9 = sum(N_bilingual_age_0_to_4, N_bilingual_age_5_to_9)/
          sum(total_age_0_to_4, total_age_5_to_9) ) # combined across ages
```


### detailed area breakdown
#### separately for each age group
```{r}
table_city_by_age_subgroup = data_table2 %>% 
  # remove provinces that don't have data on specific areas
  filter(!province %in% c("Newfoundland and Labrador", "Prince Edward Island", "Northern Canada")) %>%
  group_by(province, age_collapsed, area) %>%
  mutate(total = n()) %>% 
  group_by(province, age_collapsed, total, area,n_languages) %>%
  summarize(N=n()) %>% 
  mutate( Percent = round(N/total,3)) %>%
  ungroup() %>% 
  mutate(area = ifelse(area =="Other","zz_other",as.character(area)))%>% # so that other sorts at the end always
  filter(n_languages != "One Language")  %>% 
  rename(N_bilingual = N) %>%
  select(province, area, age_collapsed, total, N_bilingual, Percent) %>%
  arrange(province,area, -N_bilingual) 


```
#### convert to wide dataset
```{r}
table_city_wide = table_city_by_age_subgroup %>%
  select(-total) %>%
  pivot_wider(names_from = "age_collapsed", values_from = c("N_bilingual", "Percent"))
```

#### for 0-9 yo
```{r}
table_city_0_9 = table_city_by_age_subgroup %>% 
  group_by(province, area) %>%
  summarize(Percent_age_0_to_9 = sum(N_bilingual)/sum(total))
```
#### combine all ages
```{r}
table_city_full= table_city_0_9 %>% full_join(table_city_wide) %>% select(-starts_with("N_bilin"))
```


### combine all tables for canada, provinces, areas

```{r}
combined_table = total_across_canada %>% select(-starts_with("total"), -starts_with("N_bili")) %>%
  full_join( table_city_full) %>%
  full_join(table_prov_combined) %>% 
  arrange(country,province, area) %>% 
  mutate_at(vars(starts_with("Percent")), ~round(.,3)*100)


rio::export(combined_table, file = here("03_output/02_tables/Table1_bilingualism_rates.csv"))
```


## save geographical  data for maps
this is for creating a map where the area of the province represent the bilingual % in all non-gma areas (e.g., quebec without montreal, quebec city, trois rivieres, etc..) or for provinces where there are no gmas (e.g., PEI) the bilingual % for the entire province.
```{r}


## save percentages for maps (without the summary percentage for all of canada)

export(combined_table %>% filter(is.na(country)), here("03_output", "00_processed_data", "idata_geo_province.Rdata"))


```
# check rankings
```{r}
table_prov_combined %>%  
  mutate(rank_0_4 = rank(-Percent_age_0_to_4),
         rank_0_9 = rank(-Percent_age_0_to_9)) %>% 
  mutate_at(vars(starts_with("Percent")), ~round(.,3)*100) %>% 
  arrange(rank_0_9) %>% View(  )
```



## save data for poster table
xx need to figure out which of this stuff is still necessary!
```{r}

# 
# table_poster = table_prov %>% full_join(table_city %>% 
#   rename( Percent = Percent_city))  %>% 
#   full_join(table_otherCMA) %>%
#   select(province, area,total, N, Percent) %>%
#   arrange(province)
# write.csv(table_poster, file=here("03_output","02_tables","Table_idata_by_area_0_to_4.csv"),row.names = F)
```

# map data children 0-9
```{r}
table(idata_child$age_group)
child_0_9_data = idata_child %>%
  filter(age_group %in% c("0 to 4 years", "5 to 6 years", "7 to 9 years"))
```




