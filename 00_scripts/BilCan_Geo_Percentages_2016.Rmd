---
title: "Bilingualism in Canada: Geographic Distribution Tables"
author: Esther Schott (esther.schott@mail.concordia.ca)
output: html_document
---
output: 
  html_document: 
    code_folding: show
    collapsed: no
    df_print: kable
    highlight: espresso
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\\\
# load libraries
```{r load packages}
#install.packages("gpclib", type="source")

library(tidyverse)
library(rgeos)
library(rgdal)
library(maptools)
library(sp)
library(here)
library(fuzzyjoin)
library(viridis)
library(scales)
library(ggrepel)
library(rio)
```





# process census language data
## load census language data
```{r read_census_data}
idata_child = import(file = here::here("03_output","00_processed_data", "idata_preprocessed.Rdata")) 
```

# look only at children 0-4
## summarize census language data by area & province
```{r summarize_census_data}
(gma_LangGroup_data = idata_child %>%
   filter(age_group == "0 to 4 years") %>%
  group_by(province,area,n_languages) %>%
  summarize(N=n()) %>%
    mutate( Percent = round(N/sum(N),2)) %>% 
    filter(n_languages == "Two or more") ) %>%
  ungroup
    

```
## table for poster
```{r}
table_prov = idata_child %>%
  filter(age_group == "0 to 4 years") %>%
  group_by(province) %>%
  mutate(total = n()) %>% 
  group_by(province,total,n_languages) %>%
  summarize(N=n()) %>% 
    mutate( Percent = N/total)%>% 
    filter(n_languages != "One Language")  %>%
  select(-n_languages) %>%
  rename(N_bilingual = N) %>%
  mutate(area = "")

total_across_canada = table_prov %>%
  mutate(country = "canada") %>%
  group_by(country) %>%

  summarize(total= sum(total),
            N_bilingual = sum(N_bilingual)) %>%
  mutate(Percent = N_bilingual/total) %>%
  select(-country)

table_city = idata_child %>%
  filter(age_group == "0 to 4 years") %>%
  group_by(province, area) %>%
  mutate(total = n()) %>% 
  group_by(province,total, area,n_languages) %>%
  summarize(N=n()) %>% 
  mutate( Percent = round(N/total,3)) %>%
  ungroup() %>% 
  mutate(area = ifelse(area =="Other","zz_other",as.character(area)))%>% # so that other sorts at the end always
  filter(n_languages != "One Language")  %>% 
  rename(N_bilingual = N) %>%
  select(province, area, total, N_bilingual, Percent) %>%
  arrange(province,area, -N_bilingual) %>%
  filter(!province %in% c("Newfoundland and Labrador", "Prince Edward Island", "Northern Canada"))

combined_table_0_to_4 = full_join( table_city, table_prov) %>%
  full_join(total_across_canada) %>%
  arrange(province, area) %>%
  mutate(Percent = scales::percent(Percent,1))
```



## process "other" non-cma area data
this is for creating a map where the area of the province represent the bilingual % in all non-gma areas (e.g., quebec without montreal, quebec city, trois rivieres, etc..) or for provinces where there are no gmas (e.g., PEI) the bilingual % for the entire province.
```{r}


province_data = combined_table_0_to_4 %>% filter(area == "zz_other" | province %in% c("Northern Canada", "Prince Edward Island", "Newfoundland and Labrador") ) %>% select(-area)

## save percentages for maps

export(province_data, here("03_output", "00_processed_data", "idata_geo_province_0_to_4.Rdata"))

gma_LangGroup_data %>% 
  filter(area != "Other") %>%
export(., here("03_output", "00_processed_data", "idata_geo_area_0_to_4.Rdata"))

```



## save data for poster table
xx need to figure out which of this stuff is still necessary!
```{r}

# 
# table_poster = table_prov %>% full_join(table_city %>% 
#   rename( Percent = Percent_city))  %>% 
#   full_join(table_otherCMA) %>%
#   select(province, area,total, N, Percent) %>%
#   arrange(province)
# write.csv(table_poster, file=here("03_output","02_tables","Table_idata_by_area_0_to_4.csv"),row.names = F)
```

# look  at children 0-9
```{r}
table(idata_child$age_group)
gma_LangGroup_data = idata_child %>%
  filter(age_group %in% c("0 to 4 years", "5 to 6 years", "7 to 9 years"))
```

## summarize census language data by area & province
```{r summarize_census_data}
(gma_LangGroup_data = gma_LangGroup_data %>%
  group_by(province,area,n_languages) %>%
  summarize(N=n()) %>%
    mutate( Percent = round(N/sum(N),3)) %>% 
    filter(n_languages == "Two or more")  %>%
  ungroup)
    

```
## table for poster
```{r}
table_prov = idata_child %>%
  group_by(province) %>%
  mutate(total = n()) %>% 
  group_by(province,total,n_languages) %>%
  summarize(N=n()) %>% 
    mutate( Percent = round(N/total,3))%>% 
    filter(n_languages != "One Language")  %>%
  select(-n_languages)

table_city = idata_child %>%
  group_by(province,area,n_languages) %>%
  summarize(N=n()) %>%
  
    mutate( Percent_city = scales::percent(N/sum(N),1)) %>%
  ungroup() %>%
mutate(      area = ifelse(area =="Other","_other",as.character(area)))%>% 
    filter(n_languages != "One Language")  %>%
  select(-n_languages) %>%
  arrange(area,-N) %>% filter(N >250 ) 


```



## process "other" non-cma area data
```{r}

province_data = gma_LangGroup_data %>%    filter(substr(area,1,5) == "Other")

province_data$province= as.character(province_data$province)

northern_data = data.frame(province= rep("Northern Canada",3), id = c("Yukon", "Northwest Territories", "Nunavut"))

province_data  = province_data %>% full_join(northern_data) %>%
  mutate(id = ifelse(is.na(id), as.character(province), as.character(id)))

```
## save percentages for maps
```{r}
export(province_data, here("03_output", "00_processed_data", "idata_geo_province_0_to_9.Rdata"))
gma_LangGroup_data %>% 
  filter(area != "Other") %>%
export(., here("03_output", "00_processed_data", "idata_geo_area_0_to_9.Rdata"))

```



## save data for poster table
```{r}
table_otherCMA = province_data %>% group_by(province) %>% slice(1) %>% ungroup() %>% select(-id, -N) %>%
  mutate(Percent = scales::percent(Percent, 1))


table_poster = table_prov %>% full_join(table_city %>% 
  rename( Percent = Percent_city))  %>% 
  full_join(table_otherCMA) %>%
  select(province, area,total, N, Percent) %>%
  arrange(province)
write.csv(table_poster, file=here("03_output","02_tables","Table_idata_by_area_0_to_9.csv"),row.names = F)
```







