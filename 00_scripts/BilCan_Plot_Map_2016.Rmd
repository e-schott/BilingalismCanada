---
title: "Bilingualism in Canada: Plot Canada Map"
author: Esther Schott (esther.schott@mail.concordia.ca)
output: html_document
---
output: 
  html_document: 
    code_folding: show
    collapsed: no
    df_print: kable
    highlight: espresso
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Readme
important term: CMA = census metropolitan area. can be a city (e.g., Montreal) or a combination of two cities that are in the same province (if both cities are small, can be geographically close or not). In this script, I use city/metropolitan area/cma interchangeably

the map for the census paper is composed of three main components:
- map data for provinces (matched with the non-metropolitain areas % for each province). This provides the background for the plot
- map data for CMAs (matched with % for CMAs). overlaid on the non-cma % per province
- labels for CMAs (not all are shown in the current iteration of the map to prevent clutter)

# load libraries
```{r load packages}

library(tidyverse)
library(rgeos) #map-related stuff
library(rgdal) #map-related stuff
library(maptools) #map-related stuff
library(sp) #map-related stuff
library(sf)
library(here) # create working directory
library(fuzzyjoin) # for joining messy character strings
library(viridis) # colour scheme
library(scales) # for showing % in graph
library(ggrepel) # for labels
library(rio) # easier loading & saving
```


# load map data
## load map theme
```{r load_map_theme}
# decent, uncluttered map theme (needs devtools package tho)
# needed for theme_map function in ggplot call below
devtools::source_gist("https://gist.github.com/hrbrmstr/33baa3a79c5cfef0f6df")
 
```
# merge geo_data and map data
```{r}
geo_data = import( here("03_output", "00_processed_data", "idata_geo_province.Rdata"))

northern_data = data.frame(province_old = rep("Northern Canada",3), province = c("Yukon", "Northwest Territories", "Nunavut"))

provinces_with_no_cma = c("Newfoundland and Labrador", "Prince Edward Island", "Yukon", "Northwest Territories", "Nunavut")

geo_data  = geo_data %>% 
  rename(province_old = province) %>%
  full_join(northern_data) %>% 
  mutate(province = ifelse(is.na(province), province_old, province),
         type_data = ifelse(area == "", "province", "area")) %>%
  select(-province_old,  -country) %>% 
  filter(type_data  != "province" | province %in% provinces_with_no_cma )

```
# create label variables
CMA = census metropolitan area. can be a city (e.g., Montreal) or a combination of two cities that are in the same province (if both cities are small, can be geographically close or not)
```{r}
province_names = geo_data %>%  distinct(province) %>% pull(province)
cma_names = geo_data %>% filter(!area %in% c("", "zz_other")) %>% pull(area)

```


# import simplified map from prep_map
```{r}

map_coordinates <- import(here("02_map_data/simplified_map_data.Rdata")) %>%
  mutate(type = case_when( id %in% province_names ~ "province",
                           id %in% cma_names ~ "cma",
                           TRUE ~ "match failed"
                           ))

```


## prepare matching census data to  map data
```{r}
cma_census_labels = map_coordinates %>%  
  filter(type != "province") %>%
  group_by(id) %>% 
  summarize(
  # y
  long = mean(long), 
  # x 
  lat = mean(lat)) 

# try matching the census area names to the census map data (in the small dataframe that contains only one row per cma, for efficiency)
attempted_matching = stringdist_left_join(geo_data %>% filter(type_data != "province", area != "zz_other"), 
                             cma_census_labels , 
                            by = c("area" = "id"),
                             distance_col = NULL)


```
### adjust labels for non-matching CMAs

```{r troubleshoot_merging}
# fix the ones where multiple cities are combined into one metropolitain area (except for Ottawa-Gatineau, which can be treated as single city but split across two provinces)
dict_map = attempted_matching %>% 
  select(province, area, id) %>% 
  # keep only those where matching failed
    filter(is.na(id), area != "Ottawa – Gatineau") %>%
  separate(col = area, into = c("area1", "area2", "area3"), 
           remove = F, sep =c(" - | – ")) %>% 
  pivot_longer(cols = area1:area3, values_to = "area_split_up") %>%
  select(-id, -name) %>%
  filter(!is.na(area_split_up))
 

# add the split up cities to the dataframe
geo_data = geo_data %>% 
   mutate(area_for_merging = case_when(
    province == "Quebec" & area == "Ottawa – Gatineau" ~ "Ottawa - Gatineau (partie du QuÃ©bec / Quebec part)",
    province == "Ontario" & area == "Ottawa – Gatineau" ~ "Ottawa - Gatineau (Ontario part / partie de l'Ontario)	",
     TRUE ~ area
  ))

```

# merge for real

```{r}
# try matching again, to see if anything else fails?
geo_data = geo_data %>% 
    stringdist_left_join(cma_census_labels ,
                          by =c("area_for_merging" = "id"), 
                          distance_col = NULL) 

failed_merging = geo_data %>% 
  select(province, area, id, type_data) %>% 
  # keep only those where matching failed
  filter(is.na(id) | area == "Ottawa", type_data == "area", area != "zz_other") 

# if there are any rows in failed_merging, stop and check again which ones failed & fix them
stopifnot(nrow(failed_merging)==0 )



geo_data = geo_data %>%
  mutate(id = ifelse(is.na(id), province, id ))

```





# Plot Maps
## default Canada map without labels
```{r}
plot_language = "English"

legend_label = if_else(plot_language ==  "English",
                       "Rates of child\nhome bilingualism",
                       "Pourcentage des \nenfants \nbilingues")


map_plot =  ggplot() + 
  # draw province map
  geom_map(data = geo_data %>% add_row(Percent_age_0_to_9 = 0), 
           map = map_coordinates,
           aes(map_id = id, 
               fill = Percent_age_0_to_9/100),
           color="white", 
           size=0.05)+ 
      # define limits for the plot (since province_coordinates and canada_map_areas uses same scale, can use either one...)
  expand_limits(x = map_coordinates$long, 
                y = map_coordinates$lat) + 
 theme_map(base_size = 15) +
  coord_fixed(ratio=1) + 
  theme(legend.position = c(0.71, 0.53)) 

 




```
## plot in colour, save as pdf
```{r}
colour_map = map_plot + scale_fill_viridis(option = "D", begin = 0,
                       labels = scales::percent_format(accuracy=1), 
                      name=legend_label, 
                       breaks = seq(0.0,0.35, by = 0.1)
                       )

colour_map 



```


## greyscale map, save as pdf
```{r}
greyscale_map = map_plot + scale_fill_gradient(low = "white", high = "grey27", 
                       labels = scales::percent_format(accuracy = 1), 
                       name=legend_label, 
                       breaks = seq(0.0,0.35, by = 0.1))


```







## labels for biggest 10 cities (paper)
Largest city in each province (-PEI, -NL) selected, then added additional cities by largest pop across Canada to get to 10

```{r ten_cities}
ten_cities_labels = c( "Calgary", "Edmonton",  "Halifax", "Vancouver", "Winnipeg", "Moncton - Saint John", "Toronto", "Ottawa - Gatineau (Ontario part / partie de l'Ontario)", "Montréal", "Regina - Saskatoon")
set.seed(1)
labels_df <- cma_census_labels %>% 
  filter(id %in% ten_cities_labels) %>%
  mutate(id = case_when(
              id == "Ottawa - Gatineau (Ontario part / partie de l'Ontario)"~ "Ottawa -\nGatineau",
              id == "Regina - Saskatoon" ~ "Regina -\nSaskatoon",
              TRUE ~ id),
         lat_adjustment = case_when(
           id %in% c( "Vancouver", "Winnipeg") ~ -307210,
           id  %in% c( "Montréal", "Toronto", "Halifax") ~ -150000,
           id == "Ottawa -\nGatineau"~ 500000,
           id  == "Calgary" ~ -437210,
           TRUE ~ 0
           ),
         long_adjustment = case_when(
           id  %in% c( "Montréal", "Toronto") ~ 601220,
           id %in% c("Ottawa -\nGatineau","Vancouver") ~ -500000,
           TRUE ~ 0
         ))



```


# label map with colour
```{r}

colour_map + 
geom_label_repel(data = labels_df,
                 aes(x= long, y= lat, label = id),
                 size          = 3,
                 segment.size  = 1,
                 segment.color = "gray50",
                 vjust         = 1,
                 nudge_y = labels_df$lat_adjustment,
                 nudge_x = labels_df$long_adjustment) 

ggsave(here::here("03_output","01_figures","canada_map_with_labels_colour.pdf"), 
        width = 6.75, 
        height = 4.725, dpi = 300, unit = "in")
```
# greyscale map with labels
```{r}
greyscale_map + 
geom_label_repel(data = labels_df,
                 aes(x= long, y= lat, label = id),
                 size          = 3,
                 segment.size  = 1,
                 segment.color = "black",
                 box.padding = 0.3,
                 vjust         = 1,
                 nudge_y = labels_df$lat_adjustment,
                 nudge_x = labels_df$long_adjustment) 

ggsave(here::here("03_output","01_figures","canada_map_with_labels_grey.pdf"), 
        width = 6.75, 
        height = 4.725, dpi = 300, unit = "in")
```

