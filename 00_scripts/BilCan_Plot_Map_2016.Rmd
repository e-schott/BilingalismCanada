---
title: "Map visualization  for Manuscript _Youngest Bilingual Canadians_"
author: 
- Esther Schott (esther.schott@mail.concordia.ca)
- Lena V. Kremin (lena.kremin@mail.concordia.ca)
output:  
  html_document: 
    code_folding: show
    collapsed: no
    df_print: kable
    highlight: tango
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# readme
important term:
**CMA** = census metropolitan area. can be a city (e.g., Montreal) or a combination of two cities that are in the same province (if both cities are small, can be geographically close or not). 



# load libraries
```{r load packages, include = FALSE}

library(tidyverse)
library(magrittr)
library(rgeos) #map-related stuff
library(rgdal) #map-related stuff
library(maptools) #map-related stuff
library(sp) #map-related stuff
library(sf)
library(here) # create working directory
library(fuzzyjoin) # for joining messy character strings
library(viridis) # colour scheme
library(scales) # for showing % in graph
library(ggrepel) # for labels
library(rio) # easier loading & saving

```

# define variables
```{r definitions}
# some provinces/territories don't have any info on metropolitain areas. Need to treat them differently when it comes to some of the plotting steps, so create variable
provinces_with_no_cma = c("Newfoundland and Labrador", "Prince Edward Island", "Yukon", "Northwest Territories", "Nunavut")

# lookup dictionary to convert map geographical terms to data terms
northern_data = data.frame(province_old = rep("Northern Canada",3), province = c("Yukon", "Northwest Territories", "Nunavut"))

# cities for which we want labels in map output:
ten_cities_labels = c( "Calgary", "Edmonton",  "Halifax", "Vancouver", "Winnipeg", "Moncton - Saint John", "Toronto", "Ottawa - Gatineau (Ontario part / partie de l'Ontario)", "Montréal", "Regina - Saskatoon")

```

# load map data {.tabset}
## load map theme
```{r load_map_theme}
# decent, uncluttered map theme
# needed for theme_map function in ggplot call below
devtools::source_gist("https://gist.github.com/hrbrmstr/33baa3a79c5cfef0f6df")
 
```

## load map shape file
Useful  info on canadian map data in R here: https://tengl.net/blog/2020/1/7/drawing-canada-maps-in-r

the map files are downloaded from the census website, and then preprocessed in python to:
- combine the CMA and province shape files 
- simplify the shapes using https://mapshaper.org/

```{r load_map_file}
unzip(zipfile = here("02_map_data/recombined_shape_files_lambert.zip"), exdir =  here("02_map_data/simplified_census_map_2016_lambert"))

canada_census_2016 <- readOGR(dsn = here("02_map_data","simplified_census_map_2016_lambert",
                            "recombined_shape_files_lambert.shp"),
                      layer = "recombined_shape_files_lambert",
                      use_iconv = TRUE, 
                      encoding = "UTF-8")

# to look at coordinate system
#st_crs(canada_census_2016) 

# make a simpler dataframe
map_coordinates <- fortify(canada_census_2016, 
                        region="name")
# there is a minor warning about overlapping map lines, is okay to ignore 

```
# load bilingualism percentages data frame
`geo_data` is the output of the `BilCan_Geo_Percentages_2016.Rmd` script. 
Need extra step for Northern Canada, which is refered to as the individual territories in the map 
```{r load_bilingualism_data}
geo_data = import( here("03_output", "00_processed_data", "idata_geo_province.Rdata"))

geo_data  = geo_data %>% 
  rename(province_old = province) %>%
  full_join(northern_data) %>% # fix territory names
  mutate(province = ifelse(is.na(province), province_old, province),
         type_data = ifelse(area == "", "province", "area")) %>%
  select(-province_old,  -country) %>% # no longer needed
  filter(type_data  != "province" | province %in% provinces_with_no_cma )

```
## create label variables
For Provinces and CMA. 
CMA = census metropolitan area. can be a city (e.g., Montreal) or a combination of two cities that are in the same province (if both cities are small, can be geographically close or not)
```{r label_vars}
province_names = geo_data %>%  distinct(province) %>% pull(province)

cma_names = geo_data %>% filter(!area %in% c("", "zz_other")) %>% pull(area)

```
## add type variable to map data
We need to know which map areas are provinces and which are CMAs, because the matching works slightly differently
```{r type_variable}

map_coordinates %<>%
  mutate(type = case_when( id %in% province_names ~ "province",
                           id %in% cma_names ~ "cma",
                           TRUE ~ "match failed"
                           ))

```

## prepare matching census data to  map data 
### create df with all labels and their approximate coordinates
this is needed later for plotting labels for CMAs
```{r label_cmas}
cma_census_labels = map_coordinates %>%  
  filter(type != "province") %>%
  group_by(id) %>% 
  summarize(
  # y
  long = mean(long), 
  # x 
  lat = mean(lat)) 


```
### attempt matching
```{r attempt_matching}
# try matching the census area names to the census map data (in the small dataframe that contains only one row per cma, for efficiency)
attempted_matching = stringdist_left_join(geo_data %>% filter(type_data != "province", 
                                                              area != "zz_other"), 
                                          cma_census_labels , 
                                          by = c("area" = "id"),
                                          distance_col = NULL)
```



### adjust labels for non-matching CMAs

```{r troubleshoot_merging}
# fix the ones where multiple cities are combined into one metropolitain area (except for Ottawa-Gatineau, which can be treated as single city but split across two provinces)
dict_map = attempted_matching %>% 
  select(province, area, id) %>% 
  # keep only those where matching failed
    filter(is.na(id), area != "Ottawa – Gatineau") %>%
  separate(col = area, into = c("area1", "area2", "area3"), 
           remove = F, sep =c(" - | – ")) %>% 
  pivot_longer(cols = area1:area3, values_to = "area_split_up") %>%
  select(-id, -name) %>%
  filter(!is.na(area_split_up))
 

# add the split up cities to the dataframe
geo_data = geo_data %>% 
   mutate(area_for_merging = case_when(
    province == "Quebec" & area == "Ottawa – Gatineau" ~ "Ottawa - Gatineau (partie du QuÃ©bec / Quebec part)",
    province == "Ontario" & area == "Ottawa – Gatineau" ~ "Ottawa - Gatineau (Ontario part / partie de l'Ontario)	",
     TRUE ~ area
  ))

```

### merge map and percentage data

```{r merge}
# try matching again, to see if anything else fails?
geo_data = geo_data %>% 
    stringdist_left_join(cma_census_labels ,
                          by =c("area_for_merging" = "id"), 
                          distance_col = NULL) 

failed_merging = geo_data %>% 
  select(province, area, id, type_data) %>% 
  # keep only those where matching failed
  filter(is.na(id) | area == "Ottawa", 
         type_data == "area", area != "zz_other") 

# if there are any rows in failed_merging, stop and check again which ones failed & fix them
stopifnot(nrow(failed_merging)==0 )

#make sure that id always contains either the province id (if id is empty) or the cma id, for linking to map areas
geo_data = geo_data %>%
  mutate(id = ifelse(is.na(id), province, id ))

```


# Plot Maps
## create functionality for English/French map legend labels
```{r plot_legend}
plot_language = "English"

legend_label = if_else(plot_language ==  "English",
                       "Rates of child\nhome bilingualism",
                       "Pourcentage des \nenfants \nbilingues")
```

## plot map without labels {.tabset}
### preparation
```{r map_plot_setup}

map_plot =  ggplot() + 
  # draw province map
  geom_map(data = geo_data %>% add_row(Percent_age_0_to_9 = 0), # this is necessary so legend starts at 0 
           map = map_coordinates,
           aes(map_id = id, 
               fill = Percent_age_0_to_9/100),
           color="white", 
           size=0.05)+ 
      # define limits for the plot (since province_coordinates and canada_map_areas uses same scale, can use either one...)
  expand_limits(x = map_coordinates$long, 
                y = map_coordinates$lat) + 
 theme_map(base_size = 12) +
  coord_fixed(ratio=1) + 
  theme(legend.position = c(0.71, 0.53), plot.margin=grid::unit(c(0,0,0,0), "mm")) + 
  labs(x=NULL, y=NULL) # reduces white space around plot

```


### colour map
```{r colour_plot}
colour_map = map_plot + scale_fill_viridis(option = "D", begin = 0,
                       labels = scales::percent_format(accuracy=1), 
                      name=legend_label, 
                       breaks = seq(0.0,0.35, by = 0.1)
                       )

colour_map 

```
### greyscale map 
```{r greyscale_plot}
greyscale_map = map_plot + scale_fill_gradient(low = "white", high = "grey27", 
                       labels = scales::percent_format(accuracy = 1), 
                       name=legend_label, 
                       breaks = seq(0.0,0.35, by = 0.1))
greyscale_map
```

## add labels {.tabset}
### prepare labels for biggest 10 cities
Largest city in each province (-PEI, -NL) selected, then added additional cities by largest pop across Canada to get to 10

`long_adjustment` and `lat_adjustment` are created so labels hide as little of the map areas as possible, e.g., moving vancouver & calgary labels to below the province, and Montreal & Toronto labels to the right 

```{r labels_ten_cities}

set.seed(1)
labels_df <- cma_census_labels %>% 
  filter(id %in% ten_cities_labels) %>%
  mutate(id = case_when(
              id == "Ottawa - Gatineau (Ontario part / partie de l'Ontario)"~ "Ottawa -\nGatineau",
              id == "Regina - Saskatoon" ~ "Regina -\nSaskatoon",
            #  id == "Moncton - Saint John" ~ "Moncton -\nSaint John",
              TRUE ~ id),
         # adjust longitude & latitude where necessary to improve plot, this was done using trial & error
         long_adjustment = case_when(
           id  %in% c( "Montréal", "Toronto") ~ -51220,
           id == "Halifax" ~ 30000,
           id %in% c("Ottawa -\nGatineau") ~ -600000,
           id == "Vancouver" ~ -338548,
           id == "Regina -\nSaskatoon" ~ +10000,
         id == "Moncton - Saint John" ~ -100000,
           TRUE ~ 0
         ),
         lat_adjustment = case_when(
           id %in% c( "Vancouver", "Winnipeg",  "Moncton - Saint John") ~ -237210,
           id  %in% c( "Montréal", "Toronto") ~ -200000,
           id == "Ottawa -\nGatineau"~ 700000,
           id == "Edmonton" ~ 300000,
           id %in% c("Calgary") ~ -437210,
           TRUE ~ 0
           )
         )

```

### colour map with labels
```{r colour_labels}

colour_map + 
geom_text_repel(data = labels_df,
                 aes(x= long, y= lat, label = id),
                 size          = 3.5,
                 segment.size  = 1,
                 segment.color = "gray50",
                 vjust         = 1,
                 nudge_x = labels_df$long_adjustment,
                 nudge_y = labels_df$lat_adjustment,
                 color = "black",     # text color
                 bg.color = "white", # shadow color
                 bg.r = 0.15          # shadow radius
                 ) 

```
### greyscale map with labels
```{r greyscale_labels}
greyscale_map + 
geom_text_repel(data = labels_df,
                 aes(x= long, y= lat, label = id),
                 size          = 4,
                 segment.size  = 1,
                 segment.color = "black",
                 box.padding = 0.3,
                 vjust         = 1,
                 nudge_y = labels_df$lat_adjustment,
                 nudge_x = labels_df$long_adjustment,
                 color = "black",     # text color
                bg.color = "white", # shadow color
                 bg.r = 0.15          # shadow radius
                ) 


```
## save maps
```{r save_pdf}
# colour
ggsave(here::here("03_output","01_figures","canada_map_with_labels_colour.pdf"), 
       width = 6.75, 
       height =5.8, 
       dpi = 300, 
       unit = "in")

# greyscale
ggsave(here::here("03_output","01_figures","canada_map_with_labels_grey.pdf"), 
       width = 6.75, 
       height = 5.8, 
       dpi = 300, 
       unit = "in")
```

