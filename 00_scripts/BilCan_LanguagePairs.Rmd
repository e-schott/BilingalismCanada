---
title: "Language Pair Tables for Manuscript _Youngest Bilingual Canadians_"
author: 
- Esther Schott (esther.schott@mail.concordia.ca)
output:  
  html_document: 
    code_folding: show
    collapsed: no
    df_print: kable
    highlight: tango
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float: yes
#editor_options: 
#  chunk_output_type: console
---
author: Esther Schott
please email esther.schott@mail.concordia.ca if you have any questions
see poster created from earlier versions this script: https://osf.io/4gekn/

# Preparation Steps

## load packages
```{r load_packages, message = FALSE}
library(here)
library(tidyverse)
library(rio) # for more powerful import & export of data
library(labelled)
library(janitor) # cleaning up variable names
library(codebook) # better documentation
library(snakecase)
library(tidylog)

```

## read in data
```{r import_data}
idata = import(here::here("03_output","00_processed_data", "idata_preprocessed.Rdata"))

```
## minor preparation steps
### fix ottawa/gatineau area
```{r ottawa_fix}
idata = idata %>%
  mutate(area = case_when(
    province == "Quebec" & area == "Ottawa – Gatineau" ~ "Gatineau",
    province == "Ontario" & area == "Ottawa – Gatineau" ~ "Ottawa",
    TRUE ~ as.character(area)))
```


### set age group of interest
```{r age_groups}
# create variable with age groups, for easier use with filter
age_groups_of_interest = c("0 to 4 years", "5 to 6 years", "7 to 9 years")

# combine 5-6 and 7-9 ages into one, to have roughly equal age ranges (0-4:4 years, 5-9:4 years)
idata = idata %>% 
  mutate(age_collapsed = fct_collapse(age_group, 
                      "age_0_to_4" = "0 to 4 years",
                      "age_5_to_9" = c("5 to 6 years", "7 to 9 years"))) 
```


## create a long data frame with all language pairings per person
The goal of this is to show which languages are often combined with each other. For example, how many ppl are in Montreal speaking Arabic and French vs in Edmonton. It's okay if these people also speak another language. Therefore, we will create an extra dataframe that has multiple rows for trilingual ppl 

### create all possible pairings (2 languages) for the languages one person speaks
each person can report speaking between 1 and 4 languages in the census
```{r all_pairings_computed}
# create all possible pairings
idata = idata %>% 
  mutate(pairing_1 = ifelse(!is.na(lang1) & !is.na(lang2), 
                             paste(lang1, lang2, sep = "&"), NA_character_),
         pairing_2 =        ifelse(!is.na(lang1) & !is.na(lang3), 
                             paste(lang1, lang3, sep = "&"), NA_character_),
         pairing_3  =       ifelse(!is.na(lang2) & !is.na(lang3), 
                             paste(lang2, lang3, sep = "&"), NA_character_),
         pairing_4 =        ifelse(!is.na(lang1) & !is.na(lang4), 
                             paste(lang1, lang4, sep = "&"), NA_character_),
         pairing_5 =        ifelse(!is.na(lang2) & !is.na(lang4), 
                             paste(lang2, lang4, sep = "&"), NA_character_),
         pairing_6 =        ifelse(!is.na(lang3) & !is.na(lang4), 
                              paste(lang3, lang4, sep = "&"), NA_character_))
  
```

### make long dataframe with one language pair per person
someone who speaks just one language has one row, someone with 3 languages three (lang1_lang2, lang1_lang3, lang2_lang3), etc.

```{r make_longer_df}
lang_pair_data = idata %>%
  filter(n_languages_numeric>1) %>%
  gather(number, language_pair, pairing_1:pairing_6) %>%
  filter(!is.na(language_pair)) 
  
```

### fixing language combo names
we create a dataframe of all possible language combos, and then fix those, and (later) merge the fixed names back into the main dataframe
```{r lang_name_dictionary}
language_pair_dictionary = 
  # get all possible values of language pairs
  tibble(language_pair_old = unique(lang_pair_data$language_pair)) %>%
 # filter(str_detect(language_pair_old, "Other|AustroAsiatic", negate = TRUE)) %>%
  # add space for better visibility
  mutate(language_pair = gsub("&", " & ", language_pair_old),
         # flag the ones that end in English, French, Indigenous languages (want these first always)
         fix = str_detect( language_pair, "^English|^French|^Abo", negate = TRUE)) %>%
  # separate languages so we can recombine
  separate(language_pair, into = c("lang1", "lang2"), sep = " & ", remove = FALSE) %>%
  # if English, French, or Indigenous language came last, put it first now - else keep as is
  mutate(language_pair = ifelse(fix == TRUE, paste(lang2, lang1, sep = " & "), language_pair),
         language_pair = str_replace(language_pair, "Aboriginal", "Indigenous Languages" )) %>%
  # keep only old name (for matching) and new name
  select(language_pair, language_pair_old) 

# rename all language pairs for better readability
lang_pair_data  = lang_pair_data %>%
  rename(language_pair_old = language_pair) %>%
  left_join(language_pair_dictionary, by = "language_pair_old")


```

# Table 2.2: Province
## calculate totals 
how many children of each age group live in each province?

```{r totals_province}

# how many children are in the census dataset (regardless of languages spoken)
n_children_by_age = idata %>% filter(age_group %in% age_groups_of_interest) %>%
  mutate(age_collapsed = fct_collapse(age_group, 
                      "age_0_to_4" = "0 to 4 years",
                      "age_5_to_9" = c("5 to 6 years", "7 to 9 years"))) %>% 
  group_by(province, age_collapsed) %>% 
  count(name = "total_by_age") %>%
  ungroup()

```

## percentages combined for ages 0-9

### totals & percent
calculate totals and percentages in one, since the calculation is pretty easy
```{r combined_province}
lang_pair_by_province_all_ages_combined = lang_pair_data %>% 
  
  # collapse two older ages into one category
  mutate(age_combined = fct_collapse(age_group, 
                            "age_0_to_9" = age_groups_of_interest)) %>%
  filter(age_combined == "age_0_to_9") %>%
  # count how many children per language pair
  group_by(province) %>%
  count(language_pair) %>% 
  # merge in number of children collapsed across ages
   full_join(n_children_by_age %>% 
               group_by(province) %>% 
               summarize(total_by_age = sum(total_by_age))) %>%
  #calculate percentages
  mutate(percent_bilingual_children_age_0_to_9 = round(n/sum(n)*100,1), # add percent
         percent_all_children_age_0_to_9 = round(n/total_by_age*100, 1))
  
```

### create simplified language pairs lookup dictionary
some language pairs have very few speakers,  therefore we combine those into a general "Other " categories to shorten table 
This combines all language pairs with fewer than .5% of all children as speakers

```{r simplified_province}

province_lang_pair_dict = lang_pair_by_province_all_ages_combined %>%
     mutate(collapse = ifelse(percent_all_children_age_0_to_9 > .5, FALSE, TRUE),
       official_language = str_extract(language_pair, "English|French"),
         language_pair_simplified = case_when(
          collapse == FALSE & !str_detect(language_pair, "Other") ~ language_pair,
           str_detect(language_pair, "Indigenous") & n > 10 ~ language_pair,
           official_language == "English" ~ "English & Other",
           official_language == "French" ~ "French & Other",
           is.na(official_language) ~ "Other & Other"
         )) %>% 
  select(-percent_bilingual_children_age_0_to_9, -percent_all_children_age_0_to_9)
```

### re-calculate percent with new  categories
```{r recalculate_other}
lang_pair_by_province_all_ages_combined %<>%
    select(-percent_bilingual_children_age_0_to_9, -percent_all_children_age_0_to_9) %>%
  full_join(province_lang_pair_dict) %>%
  group_by(province, total_by_age, language_pair_simplified) %>% 
  summarize(n = sum(n)) %>%
  #calculate percentages
  mutate(percent_bilingual_children_age_0_to_9 = round(n/sum(n)*100,1), # add percent
         percent_all_children_age_0_to_9 = round(n/total_by_age*100, 1))
  

```


## separate for 0-4 and 5-9
### simplify language pairs
use the categories from 0-9 for consistency
```{r}

lang_pair_by_province_and_age_long  = 
  lang_pair_data %>% 
  select(person_id, province, age_group, language_pair, age_collapsed) %>%
  filter(age_group %in% age_groups_of_interest) 

lang_pair_by_province_and_age_long = lang_pair_by_province_and_age_long %>%
  full_join(province_lang_pair_dict)
  
```
### calculate percent

```{r}
lang_pair_by_province_and_age_long_counts = lang_pair_by_province_and_age_long %>%
  group_by(province, age_collapsed) %>% 
  count(language_pair_simplified) %>% 
  left_join(n_children_by_age) %>% # how how many children per age group
  mutate(total_bilingual_children = sum(n),
    percent_bilingual_children = round(n/total_bilingual_children*100,1), # add percent
    percent_all_children = round(n/total_by_age*100,1)) %>% 
  ungroup() 

# create a wide table with % biling and % all next to each other
province_by_age_wide = lang_pair_by_province_and_age_long_counts %>%
  select( - n, -total_by_age, - total_bilingual_children) %>% 
  pivot_wider(names_from = age_collapsed, 
              values_from = c("percent_bilingual_children", "percent_all_children"))

```


## combine separate and collapsed ages 
```{r province_joined}
province_language_pair_data =  
  full_join(province_by_age_wide, lang_pair_by_province_all_ages_combined) 
```

## prep output
### fix formatting for table

```{r province_formatting}
province_language_pair_data = province_language_pair_data %>%
  mutate(order_by_type = ifelse(str_detect(language_pair_simplified, "Other" ),2,1),
         province = fct_expand(province, "")) %>%
  arrange(province, order_by_type, -percent_bilingual_children_age_0_to_9) %>%
  select( -n, -total_by_age, -order_by_type) %>% # get rid of messy column name
  # reorder some columns
  relocate(language_pair_simplified, 
           .after = province) %>%
  relocate(percent_bilingual_children_age_0_to_9, 
           .after = percent_bilingual_children_age_5_to_9)


```

### write table to csv
need to create human readable version where only the first instance of area is shown in table (e.g., first instance of "Quebec" in column "province" is shown and all subsequent quebec rows are empty in col province)
```{r}
# make table human readable
table_2.2 = province_language_pair_data
table_2.2$province[duplicated(table_2.2$province)] <- ""

table_2.2 %>%
  write_csv(here("03_output", "02_tables", "Table2.2_language_pairs_by_province.csv"))

```

# Table 2.1. Canada-wide
## separate for 0-4 and 5-9
###calculate totals
```{r}
# get the numbers of bilinguals from the lang pair data frame. this counts trilinguals three times due to including all possible language pairs, but so does our count for each specific language pair. Seems ok in the grand scheme of things
bilinguals_across_canada = 
  lang_pair_data %>% 
  filter(age_group %in% age_groups_of_interest) %>% 
  group_by(age_collapsed) %>% 
  count(name = "total_bilingual_children")

# get the total number of kids at each age
totals_across_canada = n_children_by_age %>% 
  mutate(country = "Canada") %>% 
  group_by(country, age_collapsed) %>% 
  summarize(total_by_age_canada = sum(total_by_age)) %>%
  # add the numbers of bilinguals
  full_join(bilinguals_across_canada)

  
  
```
### calculate percent
```{r}
canada_language_pairs = lang_pair_by_province_and_age_long %>% 
  left_join(totals_across_canada) %>% 
  group_by(
    country, 
           age_collapsed, 
           total_by_age_canada, total_bilingual_children) %>%
 count(language_pair) %>%
  mutate(percent_bilingual_children = round(n/total_bilingual_children*100,1), # add percent
    percent_all_children = round(n/total_by_age_canada*100,1))%>% 
  ungroup() 

```




##  combined for 0-9 years
### calculate totals
```{r}
canada_totals_all_ages_combined = 
  canada_language_pairs %>%
   distinct(age_collapsed, .keep_all = TRUE) %>% 
  select(country, age_collapsed, total_by_age_canada, total_bilingual_children) %>% 
  summarize(total_canada = sum(total_by_age_canada),
            total_bilingual_children = sum(total_bilingual_children)) %>%
  mutate(age_combined = "age_0_to_9")
```
### simplify language pairs lookup dictionary
some language pairs have very few speakers, like "English&German". therefore we combine those into a general "Other" category to shorten table 
This combines all language pairs with fewer than 600 children 0-9 (roughly 0.57% of the whole dataset)
some exeptions: - combinations with Indigenous languages are never combined
```{r}
canada_language_pairs_dictionary =  canada_language_pairs %>% 
  
  mutate(age_combined = fct_collapse(age_collapsed, "age_0_to_9" = c("age_0_to_4", "age_5_to_9"))) %>%
  group_by(language_pair, age_combined) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>% 
  mutate(collapse = ifelse(n < 600, T, F),
    official_language = str_extract(language_pair, "English|French"),
         language_pair_collapsed = case_when(
          collapse == FALSE & !str_detect(language_pair, "Other") ~ language_pair,
      
           str_detect(language_pair, "Indigenous") ~ language_pair,
           official_language == "English" ~ "English & Other",
           official_language == "French" ~ "French & Other",
           is.na(official_language) ~ "Other & Other"
         ),
         language_pair_type = case_when(
           str_detect(language_pair, "Indigenous") ~ "actual",
           str_detect(language_pair, "Other") ~ "collapsed", 
           collapse == FALSE ~ "actual",
         TRUE ~ "collapsed")) %>%
  ungroup() %>%
  select(-n, -official_language, -collapse, -age_combined) %>%
  distinct()
```
### calculate percent
```{r}

canada_ages_combined = canada_language_pairs %>%
  mutate(age_combined = fct_collapse(age_collapsed, 
                            "age_0_to_9" = c("age_0_to_4", "age_5_to_9"))) %>%
  left_join(canada_language_pairs_dictionary) %>% 
  ungroup() %>%
  group_by( language_pair_collapsed, age_combined) %>%
  summarize(n = sum(n)) %>% 
  full_join(canada_totals_all_ages_combined) %>%
  mutate(percent_all_children =  round(n/total_canada *100,1),
         percent_bilingual_children = round(n/total_bilingual_children*100,1),
         country = "Canada") %>% 
  arrange(age_combined, -percent_bilingual_children) %>%
  ungroup() %>%  
  select( - n, -total_canada , - total_bilingual_children) %>% 
  # create with df with bilingual % and all % next to each other
  pivot_wider(names_from = age_combined, 
              values_from = c("percent_bilingual_children", "percent_all_children"))

```
## simplify langauge pairs for 0-4 and 5-9 
This is done using the same categories as for 0-9, hence this step here at this point. 

### calculate percent

```{r}
canada_language_pairs = canada_language_pairs %>%
  left_join(canada_language_pairs_dictionary) %>% 
  group_by(language_pair_type, language_pair_collapsed, age_collapsed) %>%
  summarize(n = sum(n)) %>%   
  left_join(totals_across_canada) %>% 
  mutate(
         percent_all_children =  round(n/total_by_age_canada*100,1),
         percent_bilingual_children = round(n/total_bilingual_children*100,1)) %>% 
  arrange(age_collapsed, -percent_bilingual_children) %>%
  ungroup()


```
### create wide dataframe (bilingual % and all % next to each other)
```{r}
# create wide data frame ( show % bilingual and % all next to each other)
canada_by_age_wide = canada_language_pairs %>% 
  # get rid of columns that vary that we won't need any more (prevent pivot_wider from functioning correctly)
  select(-n, -total_by_age_canada, -total_bilingual_children) %>% 
  pivot_wider(names_from = age_collapsed, 
              values_from = c("percent_bilingual_children", "percent_all_children"))
```

## combine tables into one

```{r}
canada_language_pair_data =  full_join(canada_by_age_wide, canada_ages_combined)
```
## write to csv
```{r}
table_2.1 = canada_language_pair_data %>%
  arrange(language_pair_type) %>%
  select(language_pair_collapsed, 
         percent_bilingual_children_age_0_to_4,
         percent_bilingual_children_age_5_to_9,
         percent_bilingual_children_age_0_to_9,
         percent_all_children_age_0_to_4,
         percent_all_children_age_5_to_9,
         percent_all_children_age_0_to_9 ) 
table_2.1 %>%
  write_excel_csv(here("03_output", "02_tables", "Table2.1_language_pairs_Canada.csv"))
```

# Table S1 census agglomerations
## separate for 0-4 and 5-9
### calculate totals
```{r}
n_children_by_age_area = idata %>% 
  filter(age_group %in% age_groups_of_interest,
         area != "Other") %>%
  mutate(age_group = fct_collapse(age_group, 
                      "age_0_to_4" = "0 to 4 years",
                      "age_5_to_9" = c("5 to 6 years", "7 to 9 years"))) %>% 
  group_by(province, area, age_group) %>% 
  count(name = "total_by_age") %>%
  ungroup()
```

### calculate percentages
```{r}
lang_pair_by_area_and_age_long  = 
  lang_pair_data %>% 
  # remove provinces that don't have metropolitan areas in census, and rural areas
  filter(!province %in% c("Newfoundland and Labrador", "Prince Edward Island", "Northern Canada"), area != "Other") %>%
  filter(age_group %in% age_groups_of_interest) %>%
   mutate(age_group = fct_collapse(age_group, 
                      "age_0_to_4" = "0 to 4 years",
                      "age_5_to_9" = c("5 to 6 years", "7 to 9 years"))) %>% 
  droplevels() %>% 
  group_by(province, area, age_group) %>% 
  count(language_pair) 

lang_pair_by_area_and_age_percent = lang_pair_by_area_and_age_long %>%
  left_join(n_children_by_age_area) # %>% # how how many children per age group
  
  


```
## combined for ages 0-9
```{r}
lang_pair_by_area_0_to_9 = lang_pair_by_area_and_age_long %>%
  mutate(age_group = fct_collapse(age_group, 
                            "age_0_to_9" = c("age_0_to_4", "age_5_to_9"))) %>% 
group_by(province, area, language_pair, age_group) %>%
  summarize(n = sum(n)) #%>% 
  
lang_pair_by_area_0_to_9_totals = 
  n_children_by_age_area %>%
  group_by(province, area) %>%
  summarize(total_by_age = sum(total_by_age)) %>%
           ungroup() 

lang_pair_by_area_0_to_9  = lang_pair_by_area_0_to_9 %>%
  full_join(lang_pair_by_area_0_to_9_totals)
```
### decide which language pairs to show based on 0-9 data
some language pairs have very few speakers, therefore we combine those into a general "Other" categories to shorten table 
This combines all language pairs with 
- fewer than 10 children
- less than 1.2 % of all children in that area
No exeption for Indigenous children because there are too few in some areas (confidentiality)
```{r}
lang_pair_by_area_summary = lang_pair_by_area_0_to_9 %>%
  mutate(ratio = (n/total_by_age)*100) %>%
  mutate(collapse = case_when(
    n < 10  ~ TRUE,
    n/total_by_age > 0.012 & !str_detect(language_pair, "Other") ~ FALSE,
    TRUE ~ TRUE)) %>%
arrange(collapse, -n) %>%
  mutate(official_language = str_extract(language_pair, "English|French"),
         language_pair_collapsed = case_when(
          collapse == FALSE & !str_detect(language_pair, "Other") ~ language_pair,
               official_language == "English" ~ "English&Other",
           official_language == "French" ~ "French&Other",
           is.na(official_language) ~ "Other & Other"
         ),
         language_pair_type = case_when(
           str_detect(language_pair, "Other") ~ "collapsed",
           n/total_by_age > 0.012 ~ "actual",
         TRUE ~ "collapsed")) %>%
  ungroup() %>%
  select(-n, -total_by_age, -official_language, -collapse, -ratio, -age_group) %>%
  distinct()

```



## combine separate age group counts and combined
```{r}
lang_pair_by_area = rbind(lang_pair_by_area_0_to_9, lang_pair_by_area_and_age_percent)
```

## simplify language pairs
using same rules as for 0-9 (`lang_pair_by_area_summary`) for consistency
```{r}
lang_pair_by_area = lang_pair_by_area %>%
  
  ungroup() %>%
  group_by(province, area, age_group, total_by_age) %>%
 # summarize(n = sum(n)) #%>%
  # calculate total number of bilingual children for calculating % of bilingual children
  mutate(total_bilingual_children = sum(n)) %>%
  full_join(lang_pair_by_area_summary) %>% 
  group_by(province, area, age_group, total_by_age, language_pair_collapsed, language_pair_type, total_bilingual_children) %>%
  summarize(n = sum(n)) %>% 
      mutate(
         percent_bilingual_children = round(n/total_bilingual_children*100,1), # add percent
    percent_all_children = round(n/total_by_age*100,1)) %>% 
  ungroup() %>%
  arrange(province, area, age_group, language_pair_type, -n)
  
```
## prepare for output format
### switch to wide layout
```{r}
lang_pair_by_area_wide = lang_pair_by_area %>%
  select(-n, -total_by_age, - total_bilingual_children, -language_pair_type) %>% 
  pivot_wider(names_from = age_group, 
              values_from = c("percent_bilingual_children", "percent_all_children"))  %>%
  select(province, area, language_pair_collapsed, percent_bilingual_children_age_0_to_4, percent_bilingual_children_age_5_to_9, percent_bilingual_children_age_0_to_9, percent_all_children_age_0_to_4, percent_all_children_age_5_to_9,
 percent_all_children_age_0_to_9,)
# need to deal with some inconsistencies, but ok otherwise
```



### for paper
need to create human readable version where only the first instance of area is shown in table (e.g., first instance of "Quebec" in column "province" is shown and all subsequent quebec rows are empty in col province)
```{r}
lang_pair_by_area_wide = 
  lang_pair_by_area_wide %>%
    mutate(language_pair_collapsed = gsub("&", " & ", language_pair_collapsed),
           province = fct_expand(province, ""))

#  formatting changes to make easier to read by human
table_2.3 = lang_pair_by_area_wide
table_2.3$area[duplicated(table_2.3$area)] <- ""
table_2.3$province[duplicated(table_2.3$province)] <- ""
table_2.3 %>%
  write_excel_csv(here("03_output", "02_tables", "TableS1_language_pairs_by_area.csv"))

```

### for dashboard app: machine readable table
```{r}
# machine readable table 
combined_table = lang_pair_by_area_wide %>% mutate(type = "cma", region = area) %>%
  full_join(province_language_pair_data %>% mutate(type = "province", region = province) %>% rename(language_pair_collapsed = language_pair_simplified)) %>%
  full_join(table_2.1 %>% mutate(type = "canada", region = "Canada")) %>%
  relocate(type, region, .before = language_pair_collapsed) %>%
  relocate(province, area, .after= percent_all_children_age_0_to_9) 

combined_table %>%
  write_excel_csv(here("03_output", "02_tables", "Tables_language_pairs_for_computer.csv"))

```



# the end
added a beep sound because it sometimes takes long to run, notifies when done
```{r}
beepr::beep("ping")
```

