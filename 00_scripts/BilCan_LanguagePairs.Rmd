---
title: "Census Bilingualism Language Pair Analysis"
output:
  html_document:
    df_print: paged
---
author: Esther Schott
please email esther.schott@mail.concordia.ca if you have any questions
see poster created from earlier versions this script: https://osf.io/4gekn/

# Preparation Steps

## load packages
```{r echo=FALSE}
library(here)
library(tidyverse)
library(rio) # for more powerful import & export of data
library(labelled)
library(janitor) # cleaning up variable names
library(codebook) # better documentation
library(snakecase)

```

## read in data
```{r}
idata = import(here::here("03_output","00_processed_data", "idata_preprocessed.Rdata"))



```

## fix ottawa/gatineau area
```{r}
idata = idata %>%
  mutate(area = case_when(
    province == "Quebec" & area == "Ottawa – Gatineau" ~ "Gatineau",
    province == "Ontario" & area == "Ottawa – Gatineau" ~ "Ottawa",
    TRUE ~ as.character(area)))
```


## set age group of interest
```{r}
# create variable with age groups, for easier use with filter
age_groups_of_interest = c("0 to 4 years", "5 to 6 years", "7 to 9 years")

# combine 5-6 and 7-9 ages into one, to have roughly equal age ranges (0-4:4 years, 5-9:4 years)
idata = idata %>% 
  mutate(age_collapsed = fct_collapse(age_group, 
                      "age_0_to_4" = "0 to 4 years",
                      "age_5_to_9" = c("5 to 6 years", "7 to 9 years"))) 
```


## create a long data frame with all language pairings per person
The goal of this is to show which languages are often combined with each other. For example, how many ppl are in Montreal speaking Arabic and French vs in Edmonton. It's okay if these people also speak another language. Therefore, we will create an extra dataframe that has multiple rows for trilingual ppl 
### create all possible pairings (2 languages) for the languages one person speaks
each person can report speaking between 1 and 4 languages in the census
```{r}
# create all possible pairings
idata = idata %>% 
  mutate(pairing_1 = ifelse(!is.na(lang1) & !is.na(lang2), 
                             paste(lang1, lang2, sep = "&"), NA_character_),
         pairing_2 =        ifelse(!is.na(lang1) & !is.na(lang3), 
                             paste(lang1, lang3, sep = "&"), NA_character_),
         pairing_3  =       ifelse(!is.na(lang2) & !is.na(lang3), 
                             paste(lang2, lang3, sep = "&"), NA_character_),
         pairing_4 =        ifelse(!is.na(lang1) & !is.na(lang4), 
                             paste(lang1, lang4, sep = "&"), NA_character_),
         pairing_5 =        ifelse(!is.na(lang2) & !is.na(lang4), 
                             paste(lang2, lang4, sep = "&"), NA_character_),
         pairing_6 =        ifelse(!is.na(lang3) & !is.na(lang4), 
                              paste(lang3, lang4, sep = "&"), NA_character_))
  
```

### make long dataframe with one language pair per person
someone who speaks just one language has one row, someone with 3 languages three (lang1_lang2, lang1_lang3, lang2_lang3), etc.
```{r}
lang_pair_data = idata %>%
  filter(n_languages_numeric>1) %>%
  gather(number, language_pair, pairing_1:pairing_6) %>%
  filter(!is.na(language_pair)) 
  
```

### fixing language combo names
we create a dataframe of all possible language combos, and then fix those, and (later) merge the fixed names back into the main dataframe
```{r}
language_pair_dictionary = 
  # get all possible values of language pairs
  tibble(language_pair_old = unique(lang_pair_data$language_pair)) %>%
  filter(str_detect(language_pair_old, "Other|AustroAsiatic", negate = TRUE)) %>%
  # add space for better visibility
  mutate(language_pair = gsub("&", " & ", language_pair_old),
         # flag the ones that end in English, French, aboriginal languages (want these first always)
         fix = str_detect( language_pair, "^English|^French|^Abo", negate = TRUE)) %>%
  # separate languages so we can recombine
  separate(language_pair, into = c("lang1", "lang2"), sep = " & ", remove = FALSE) %>%
  # if English, French, or aboriginal language came last, put it first now - else keep as is
  mutate(language_pair = ifelse(fix == TRUE, paste(lang2, lang1, sep = " & "), language_pair)) %>%
  # keep only old name (for matching) and new name
  select(language_pair, language_pair_old)

```

# Table 2: look at languages by province

## percentage out of bilingual/all children by age group
 separate for 0-4 and 5-9 yo
### by province
#### calculate totals 
```{r}

# how many children are in the census dataset (regardless of languages spoken)
n_children_by_age = idata %>% filter(age_group %in% age_groups_of_interest) %>%
  mutate(age_collapsed = fct_collapse(age_group, 
                      "age_0_to_4" = "0 to 4 years",
                      "age_5_to_9" = c("5 to 6 years", "7 to 9 years"))) %>% 
  group_by(province, age_collapsed) %>% 
  count(name = "total_by_age") %>%
  ungroup()

```


#### calculate percent
```{r}

lang_pair_by_province_and_age_long  = 
  lang_pair_data %>% 
  filter(age_group %in% age_groups_of_interest) %>%
  group_by(province, age_collapsed) %>% 
  count(language_pair) %>% 
  left_join(n_children_by_age) %>% # how how many children per age group
  mutate(n_bilingual_children = sum(n),
    percent_bilingual_children = round(n/n_bilingual_children*100,1), # add percent
    percent_all_children = round(n/total_by_age*100,1)) %>% 
  ungroup() 

# create a wide table with % biling and % all next to each other
province_by_age_wide = lang_pair_by_province_and_age_long %>%
  select( - n, -total_by_age, - n_bilingual_children) %>% 
  pivot_wider(names_from = age_collapsed, 
              values_from = c("percent_bilingual_children", "percent_all_children"))

```




## percentages combined for ages 0-9

### by province (totals & percent)
calculate totals and percentages in one, since the calculation is pretty easy
```{r}
lang_pair_by_province_all_ages_combined = lang_pair_data %>% 
  
  # collapse two older ages into one category
  mutate(age_combined = fct_collapse(age_group, 
                            "age_0_to_9" = age_groups_of_interest)) %>%
  filter(age_combined == "age_0_to_9") %>%
  # count how many children per language pair
  group_by(province) %>%
  count(language_pair) %>% 
  # merge in number of children collapsed across ages
   full_join(n_children_by_age %>% 
               group_by(province) %>% 
               summarize(total_by_age = sum(total_by_age))) %>%
  #calculate percentages
  mutate(percent_bilingual_children_age_0_to_9 = round(n/sum(n)*100,1), # add percent
         percent_all_children_age_0_to_9 = round(n/total_by_age*100, 1)) %>% 
  select(-n, -total_by_age)
  
```
### for all of canada
#### separeated by age
calculate totals
```{r}
totals_across_canada = lang_pair_by_province_and_age_long %>% 
  mutate(country = "Canada") %>% 
  group_by(province, age_collapsed) %>%
  top_n(n, n = 1) %>%
  select(country, province, age_collapsed,  n_bilingual_children, total_by_age)%>%
  group_by(country, age_collapsed) %>%
  summarize(total_by_age_canada = sum(total_by_age),
            n_bilingual_by_age_canada = sum(n_bilingual_children))
```
#### calculate percent
```{r}
canada_language_pairs = lang_pair_by_province_and_age_long %>% 
  left_join(totals_across_canada) %>% 
  group_by(country, age_collapsed, language_pair, total_by_age_canada, n_bilingual_by_age_canada) %>%
  summarise(n_canada = sum(n)) 

```




### all of canada 0-9
#### calculate totals
```{r}
canada_totals_all_ages_combined = 
  canada_language_pairs %>% ungroup() %>%
   distinct(age_collapsed, .keep_all = TRUE) %>% 
  select(country, age_collapsed, total_by_age_canada, n_bilingual_by_age_canada) %>% 
  summarize(total_by_age_canada = sum(total_by_age_canada),
            n_bilingual_by_age_canada = sum(n_bilingual_by_age_canada)) %>%
  mutate(age_combined = "age_0_to_9")
```
### combine language pairs
```{r}
canada_language_pairs_dictionary =  canada_language_pairs %>% 
  
  mutate(age_combined = fct_collapse(age_collapsed, "age_0_to_9" = c("age_0_to_4", "age_5_to_9"))) %>%
  group_by(language_pair, age_combined) %>%
  summarize(n = sum(n_canada)) %>%
  ungroup() %>%
  mutate(collapse = ifelse(n > 600, F, T),
    official_language = str_extract(language_pair, "English|French"),
         language_pair_collapsed = case_when(
          collapse == FALSE & !str_detect(language_pair, "Other") ~ language_pair,
      
           str_detect(language_pair, "Aboriginal") ~ language_pair,
           official_language == "English" ~ "English & Other",
           official_language == "French" ~ "French & Other",
           is.na(official_language) ~ "Other & Other"
         ),
         language_pair_type = case_when(
           str_detect(language_pair, "Aboriginal") ~ "actual",
           str_detect(language_pair, "Other") ~ "collapsed", 
           collapse == FALSE ~ "actual",
        #   n/total_by_age > 0.012 ~ "actual",
         TRUE ~ "collapsed")) %>%
  ungroup() %>%
  select(-n, -official_language, -collapse, -age_combined) %>%
  distinct()
```
#### calculate percent
```{r}

canada_ages_combined = canada_language_pairs %>%
  mutate(age_combined = fct_collapse(age_collapsed, 
                            "age_0_to_9" = c("age_0_to_4", "age_5_to_9"))) %>%
  left_join(canada_language_pairs_dictionary) %>% ungroup() %>%
  select(-language_pair) %>%
  group_by(language_pair_type, language_pair_collapsed, age_combined) %>%
  summarize(n = sum(n_canada)) %>%
  full_join(canada_totals_all_ages_combined) %>%
  mutate(percent_all_children =  round(n/total_by_age_canada*100,1),
         percent_bilingual_children = round(n/n_bilingual_by_age_canada*100,1),
         country = "Canada") %>% 
  arrange(age_combined, -percent_bilingual_children) %>%
  ungroup() %>%  
  select( - n, -total_by_age_canada, - n_bilingual_by_age_canada) %>% 
  pivot_wider(names_from = age_combined, 
              values_from = c("percent_bilingual_children", "percent_all_children"))

```
###separate for each age

## calculate percent

```{r}
canada_language_pairs_new = canada_language_pairs %>%
  left_join(canada_language_pairs_dictionary) %>% 
  group_by(language_pair_type, language_pair_collapsed, age_collapsed) %>%
  summarize(n = sum(n_canada)) %>%   
  left_join(totals_across_canada) %>% 
  mutate(
         percent_all_children =  round(n/total_by_age_canada*100,1),
         percent_bilingual_children = round(n/n_bilingual_by_age_canada*100,1)) %>% 
  arrange(age_collapsed, -percent_bilingual_children) %>%
  ungroup()
# create wide data frame ( show % bilingual and % all next to each other)
canada_by_age_wide = canada_language_pairs_new %>% 
  # get rid of columns that vary that we won't need any more (prevent pivot_wider from functioning correctly)
  select(-n, -total_by_age_canada, -n_bilingual_by_age_canada) %>% 
  pivot_wider(names_from = age_collapsed, 
              values_from = c("percent_bilingual_children", "percent_all_children"))
```

## combine tables into one

```{r}
canada_language_pair_data =  full_join(canada_by_age_wide, canada_ages_combined)
```
## write to csv
```{r}
canada_language_pair_data %>%
  arrange(language_pair_type) %>%
  select(language_pair_collapsed, 
         percent_bilingual_children_age_0_to_4,
         percent_bilingual_children_age_5_to_9,
         percent_bilingual_children_age_0_to_9,
         percent_all_children_age_0_to_4,
         percent_all_children_age_5_to_9,
         percent_all_children_age_0_to_9 ) %>%
  write_excel_csv(here("03_output", "02_tables", "Table2_language_pairs_Canada.csv"))
```

#### province 
```{r}
province_language_pair_data =  
  full_join(province_by_age_wide, lang_pair_by_province_all_ages_combined) 
```

### combine province and all of canada data
```{r}
full_table = full_join(province_language_pair_data, canada_language_pair_data)
```

### fix formatting for table

```{r}

full_table = full_table %>%
  # remove other label
  mutate( other_flag = str_detect(language_pair, "Other")) %>%
  filter(other_flag != TRUE) %>% 
  # exclude language combos that appear very rarely
  filter(percent_all_children_age_0_to_9 > .5) %>% 
  select(-other_flag) %>%
  arrange(province, -percent_bilingual_children_age_0_to_9) %>%
    # fix language pair names
  rename(language_pair_old = language_pair) %>% 
  left_join(language_pair_dictionary, by = "language_pair_old") %>%
  select(-language_pair_old) %>% # get rid of messy column name
  # reorder some columns
  relocate(language_pair, 
           .after = province) %>%
  relocate(country, .before = province) %>%
  relocate(percent_bilingual_children_age_0_to_9, 
           .after = percent_bilingual_children_age_5_to_9)


```

## write table to csv
```{r}
full_table$province[duplicated(full_table$province)] <- ""

full_table %>%
  write_csv(here("03_output", "02_tables", "Table2_language_pairs_by_province.csv"))

```
# census agglomerations
## calculate totals
```{r}
n_children_by_age_area = idata %>% 
  filter(age_group %in% age_groups_of_interest,
         area != "Other") %>%
  mutate(age_group = fct_collapse(age_group, 
                      "age_0_to_4" = "0 to 4 years",
                      "age_5_to_9" = c("5 to 6 years", "7 to 9 years"))) %>% 
  group_by(province, area, age_group) %>% 
  count(name = "total_by_age") %>%
  ungroup()
```

## calculate percentages
```{r}
lang_pair_by_area_and_age_long  = 
  lang_pair_data %>% 
  # remove provinces that don't have metropolitan areas in census, and rural areas
  filter(!province %in% c("Newfoundland and Labrador", "Prince Edward Island", "Northern Canada"), area != "Other") %>%
  filter(age_group %in% age_groups_of_interest) %>%
   mutate(age_group = fct_collapse(age_group, 
                      "age_0_to_4" = "0 to 4 years",
                      "age_5_to_9" = c("5 to 6 years", "7 to 9 years"))) %>% 
  droplevels() %>% 
  group_by(province, area, age_group) %>% 
  count(language_pair) 

lang_pair_by_area_and_age_percent = lang_pair_by_area_and_age_long %>%
  left_join(n_children_by_age_area) # %>% # how how many children per age group
  
  


```
## combined for ages 0-9
```{r}
lang_pair_by_area_0_to_9 = lang_pair_by_area_and_age_long %>%
  mutate(age_group = fct_collapse(age_group, 
                            "age_0_to_9" = c("age_0_to_4", "age_5_to_9"))) %>% 
group_by(province, area, language_pair, age_group) %>%
  summarize(n = sum(n)) #%>% 
  
lang_pair_by_area_0_to_9_totals = 
  n_children_by_age_area %>%
  group_by(province, area) %>%
  summarize(total_by_age = sum(total_by_age)) %>%
           ungroup() 

lang_pair_by_area_0_to_9  = lang_pair_by_area_0_to_9 %>%
  full_join(lang_pair_by_area_0_to_9_totals)
```
## decide which language pairs to show based on 0-9 data
```{r}
lang_pair_by_area_summary = lang_pair_by_area_0_to_9 %>%
  mutate(ratio = (n/total_by_age)*100) %>%
  mutate(collapse = case_when(
    n < 10  ~ TRUE,
    n/total_by_age > 0.012 & !str_detect(language_pair, "Other") ~ FALSE,
    TRUE ~ TRUE)) %>%
arrange(collapse, -n) %>%
  mutate(official_language = str_extract(language_pair, "English|French"),
         language_pair_collapsed = case_when(
          collapse == FALSE & !str_detect(language_pair, "Other") ~ language_pair,
      # not enough kids with aboriginal languages to include that as a separate category
            #    str_detect(language_pair, "Aboriginal") ~ language_pair,
           official_language == "English" ~ "English&Other",
           official_language == "French" ~ "French&Other",
           is.na(official_language) ~ "Other&Other"
         ),
         language_pair_type = case_when(
         #  str_detect(language_pair, "Aboriginal") ~ "actual",
           str_detect(language_pair, "Other") ~ "collapsed",
           n/total_by_age > 0.012 ~ "actual",
         TRUE ~ "collapsed")) %>%
  ungroup() %>%
  select(-n, -total_by_age, -official_language, -collapse, -ratio, -age_group) %>%
  distinct()

 lang_pair_by_area_summary %>%
   select(-language_pair) %>%
  distinct(province, area, language_pair_collapsed) %>% View( )
```



# combine separate age group counts and combined
```{r}
lang_pair_by_area = rbind(lang_pair_by_area_0_to_9, lang_pair_by_area_and_age_percent)
```

## simplify language pairs
```{r}
lang_pair_by_area = lang_pair_by_area %>%
  
  ungroup() %>%
  group_by(province, area, age_group, total_by_age) %>%
 # summarize(n = sum(n)) #%>%
  # calculate total number of bilingual children for calculating % of bilingual children
  mutate(n_bilingual_children = sum(n)) %>%
  full_join(lang_pair_by_area_summary) %>% 
  group_by(province, area, age_group, total_by_age, language_pair_collapsed, language_pair_type, n_bilingual_children) %>%
  summarize(n = sum(n)) %>% 
      mutate(
         percent_bilingual_children = round(n/n_bilingual_children*100,1), # add percent
    percent_all_children = round(n/total_by_age*100,1)) %>% 
  ungroup() %>%
  arrange(province, area, age_group, language_pair_type, -n)
  
```
# switch to wide layout
```{r}
lang_pair_by_area_wide = lang_pair_by_area %>%
  select(-n, -total_by_age, - n_bilingual_children, -language_pair_type) %>% 
  pivot_wider(names_from = age_group, 
              values_from = c("percent_bilingual_children", "percent_all_children"))  %>%
  select(province, area, language_pair_collapsed, percent_bilingual_children_age_0_to_4, percent_all_children_age_0_to_4, percent_bilingual_children_age_5_to_9, percent_all_children_age_5_to_9,
percent_bilingual_children_age_0_to_9, percent_all_children_age_0_to_9,)
# need to deal with some inconsistencies, but ok otherwise
```



## for paper
```{r}
Table_2.3 = 
  lang_pair_by_area_wide %>% 
  filter(area %in% c("Toronto", "Montréal", "Vancouver", "Ottawa", "Gatineau")) 


# silly formatting changes

Table_2.3$area[duplicated(Table_2.3$area)] <- ""
Table_2.3$province[duplicated(Table_2.3$province)] <- ""
Table_2.3 %>%
  write_excel_csv(here("03_output", "02_tables", "Table2.3_language_pairs_by_area.csv"))

```


# the end
```{r}
beepr::beep("ping")
```

