---
title: "Census Bilingualism Pre-processing HOUSEHOLDS"
output:
  html_document:
    df_print: paged
---
author: Esther Schott
please email esther.schott@mail.concordia.ca if you have any questions
see poster created from a previous version of this script: https://osf.io/4gekn/

# 1. Preparation Steps
## Script settings
```{r}
load_data_from_raw = FALSE # If true, loads data from .sav, else loads R file (faster)

use_reduced_data_set = TRUE # If true, uses a smaller subset of full data set (for troubleshooting etc.)
```

## load packages
```{r echo=FALSE}
library(here)
library(tidyverse)
library(rio) # for reading in SPSS files
library(labelled)
#library(cowplot)
#library(viridis)
library(janitor)

library(codebook)


library(scales)



```



#  HOUSEHOLDS dataset




## read in dataset 
```{r}
# need to change to reading in factor solution as above
if(load_data_from_raw == TRUE) {
  raw_hhdata = rio::import(here("01_datasets/pumf-98M0002-E-2016-hierarchical_F1.sav"),format = "sav", user_na = c("Not available", "88888888", "99999999"))
  saveRDS(raw_hhdata, here("03_output/00_processed_data/hdata_raw.Rdata"))} else {
  raw_hhdata = readRDS(here("03_output/00_processed_data/hdata_raw.Rdata"))
}

#dict = tibble(old_name = names(raw_hhdata), explanation = var_label(raw_hhdata))
#export(dict, file = here("01_datasets/ColNamesDict.csv"))
hh_column_names = import(here("01_datasets/ColNamesDict_hhdata.csv"))




```
## data cleaning - general

### clean up column names
```{r}
# we only want to rename columns that we created a new name for
hh_column_names_keep = hh_column_names %>%
  filter(new_name!="")
# rename columns to new name
# pull() is necessary to convert column to vector (which rename_at expects)
raw_hhdata = raw_hhdata %>% rename_at(vars(pull(hh_column_names_keep,old_name)), ~ pull(hh_column_names_keep,new_name))
```
### convert to categorical variables to factors to see variable labels
```{r}
# make factor - the spss variable has all variables stored as numeric, which makes them read into R as numeric (which means it doesn't show labels present in the dataset). Can use factorize to remedy that 

# from the column dictionary, keep only columns that are categorical 
columns_to_convert_to_factor = hh_column_names %>%
  filter(type == "categorical") %>%
  mutate(current_name = if_else(new_name== "", old_name, new_name)) %>% # some of these columns have been renamed, use new name if it was renamed
  pull(current_name)


# batch convert to factor
# this takes a bit long
raw_hhdata = raw_hhdata %>%
  mutate_at(.vars = vars(columns_to_convert_to_factor),
             .funs = factorize)
# now, instead of numbers e.g. for provice we see the actual label in the df
```



### select variables of interest
```{r}
# select which variables are necessary for our analysis
# keep all that we have renamed (to include more, edit the ColNamesDict.csv in datasets folder)

hhdata = raw_hhdata %>% select(pull(hh_column_names_keep, new_name))
```





### create variable for households with children 9 and under

```{r}
# create a variable that says whether child younger than 10 lives in household


hhdata = hhdata %>% 
  mutate(child0_9 = ifelse(age_group == "0 to 9 years", 1,0)) %>%
    group_by(household_id) %>%
  mutate(children_per_hh = sum(child0_9)) %>%
  ungroup()



```

### use subset of full data (for troubleshooting)
This is necessary while creating the code because some code is SLOW. change use_reduced_data_set to change at the top of the script
```{r}

if(use_reduced_data_set == TRUE) {
  # select X unique households to keep in subset
  household_subsample = sample(unique(hhdata$household_id),
                               20000)  
  hhdata = hhdata %>%
    filter(household_id %in% household_subsample)
}

```

### clean up area variable
```{r}
hhdata = hhdata %>%
  mutate(area = sub(" .*", "", area))

```



## data cleaning -   language variables
```{r}

#make this simpler


hhdata = hhdata %>%
  mutate_at( .vars = vars(lang_most_eng, lang_most_fre, lang_regular_eng, lang_regular_fre, lang_regular_oth),
             ~ fct_relabel(., ~str_remove(., '\\s*-.*')))

# create a variable that functions like all other home language variables and just says true/false for lang_most_oth_write_in  
hhdata = hhdata %>% 
  mutate(lang_most_oth = case_when(
    lang_most_oth_write_in == "No non-official language" ~ "False",
    lang_most_oth_write_in == "Not available" ~ NA_character_,
    !is.na(lang_most_oth_write_in) ~ "True"
  ))
# test that this is working: 
# table(hhdata$lang_most_oth_write_in, hhdata$lang_most_oth)

###LK: do the same for mother tongue?

```
### clean up Write-in component for non-official languages
```{r}
hhdata = hhdata %>%
  
  mutate(lang_most_oth_write_in = case_when(
    lang_most_oth_write_in == "No non-official language" ~ "",
    lang_most_oth_write_in == "Not available" ~ NA_character_,
    lang_most_oth_write_in == "All other single languages" ~ "Other",
    TRUE ~  sub(" .*", "", lang_most_oth_write_in)
  ))
    
```



### calculate number of languages spoken (individual)

```{r}
# count how many lanuages each person speaks:
true_false_language_columns = c("lang_most_eng", "lang_most_fre", "lang_most_oth","lang_regular_eng", "lang_regular_fre", "lang_regular_oth")

hhdata = hhdata  %>% 
  mutate(N_languages_person_numeric = rowSums(.[true_false_language_columns] == "True", na.rm = TRUE),
         N_languages_person = # make this a categorical variable
           case_when(N_languages_person_numeric == 0 ~ NA_character_,
                     N_languages_person_numeric == 1 ~ "One Language",
                     N_languages_person_numeric > 1 ~ "Two or more",
                     TRUE ~ NA_character_))

# check result:
#View(hhdata %>% select(household_id, person_id, lang_most_eng:lang_regular_oth, lang_most_oth, N_languages_individual))


```

### create language pairs variable

```{r}
# we need a column that says what languages that person speaks. So English_French, English&Italian&Other etc. 
# if a person speaks a language at home (value is "True"), then copy the column name to new column lang_pair_ordered

# sorted by most spoken then regularly spoken languages (for the person)
hhdata$lang_pair_ordered <- apply(hhdata[true_false_language_columns], 1, function(x) paste(names(x[x=="True"]), collapse="&"))



# this takes a long time to run 
# now we need to clean up the messy column names in each row:
hhdata = hhdata %>%
  mutate( lang_pair_ordered = str_remove(lang_pair_ordered, "(NA&)+|(&NA)+"), # remove NA in beginning and middle
   lang_pair_ordered =str_remove(lang_pair_ordered,"&NA"), # remove NAs at End
   lang_pair_ordered = str_replace(lang_pair_ordered, "(lang_most_eng)+|(lang_regular_eng)+", "English"), # substite English column names with word english
   lang_pair_ordered = str_replace(lang_pair_ordered, "(lang_most_fre)+|(lang_regular_fre)+", "French"), # same for french
   lang_pair_ordered = str_replace(lang_pair_ordered, "lang_most_oth", as.character(lang_most_oth_write_in)),
   lang_pair_ordered = str_replace(lang_pair_ordered, "lang_regular_oth", "Other") # for lang_regular_oth we don't know language, just call it other
   )

# check result:
#View(hhdata %>% select(household_id, person_id, lang_most_eng:lang_regular_oth, lang_most_oth, N_languages_individual, lang_pair_ordered))




```
### create variables for each language in dataset
```{r}

hhdata  =  hhdata %>%
  separate(lang_pair_ordered, c("lang1", "lang2", "lang3", "lang4"), remove = FALSE)
# warning that not all people have 4 languages is normal
```



### simplify language pairs variable (sorted A-Z)
```{r}

# remove order by most spoken then regularly spoken languages (now sorted by A-Z)
hhdata$lang_pair <- apply(hhdata[c("lang1", "lang2", "lang3","lang4")], 1, function(x) paste(sort(x[!is.na(x)]), collapse="&"))

```
## get columns back in alphabetical order
```{r}
hhdata = hhdata %>% select(sort(names(hhdata)))
```


# Descriptives
## keep only households with kids under 10
```{r}
# restrict to kids under 10
# keep only households that have at least one child under 10
hhdata_child = hhdata %>%
  filter(children_per_hh >0)
```


## summary tables: children under 9 years
```{r}


# number of bilinguals
#canadian average:
hhdata_child %>%
filter(age_group=="0 to 9 years") %>%
  group_by(N_languages_person) %>%
  summarize(N=n()) %>%
    mutate( Percent = N/sum(N)) 





(area_lang_data = hhdata_child %>%
filter(age_group=="0 to 9 years") %>%
  group_by(province,area,N_languages_person) %>%
  summarize(N=n()) %>%
    mutate( Percent = round(N/sum(N),3))%>%
    filter(N_languages_person != "One Language"))


# # specific language combos
 hhdata_child_langPair = hhdata_child %>%
   filter(age_group=="0 to 9 years",N_languages_person_numeric>1 ) %>%
   group_by(province,lang_pair) %>%
   summarize(N=n())%>%
   mutate( Percent = round(N/sum(N),3))%>%
   arrange(province, -N)

 hhdata_child_langPair=hhdata_child_langPair %>% group_by(province) %>%
   slice(1:5) %>%
   mutate(id=seq_along(Percent))

# add nicer language labels to graph (need to adapt to new data)
#lang_dict = read_csv(file= here("01_datasets","LangPair_Dict_2016.csv"))
#hhdata_child_langPair = full_join(hhdata_child_langPair, lang_dict, by = c("lang_pair"= "Lang_Combo_top2" )


```


# export for analysis in other scripts
```{r}

# this contains ALL households (in case another analysis needs all data)
export(hhdata, file = here("03_output/00_processed_data/hhdata_preprocessed.Rdata"))
```





# getting data from only adults in child's households
```{r}
# filter out children
hhdata_child_adult <- hhdata_child %>% 
  filter(child0_9 == 0)
  
# see number of adults per household
adults_n <- hhdata_child_adult %>% 
  # group by household
  group_by(household_id) %>% 
  summarize(n_adults = n())
# number of adults per household ranges 1 - 6



### language

# get language (pairs) and number of speakers per household
adults_lang <- hhdata_child_adult %>% 
  group_by(household_id, lang_pair_ordered) %>% 
  summarize(n_lang_pair = n())

# get number of bilingual adults per household
adults_biling_n <- adults_lang %>% 
  filter(str_detect(lang_pair_ordered, "&")) %>% 
  group_by(household_id) %>% 
  summarize(n_biling_adults = sum(n_lang_pair)) 

# get number of monolingual adults per household
adults_monoling_n <- adults_lang %>% 
  filter(!str_detect(lang_pair_ordered, "&")) %>% 
  mutate(lang_pair_ordered = na_if(lang_pair_ordered, "NA")) %>% 
  filter(!is.na(lang_pair_ordered)) %>% 
  group_by(household_id) %>% 
  summarize(n_monoling_adults = sum(n_lang_pair))

# combine info on adults' language
adults_n <- adults_n %>% 
  left_join(adults_biling_n, by = "household_id") %>% 
  left_join(adults_monoling_n, by = "household_id") %>% 
  # add values in if we know there are no reported bilingual adults in the HH
  mutate(n_biling_adults = case_when(
    n_adults - n_monoling_adults == 0 ~ 0,
    TRUE ~ as.numeric(as.character(.$n_biling_adults))
  )) %>% 
  mutate(n_biling_adults_group = case_when(
           n_biling_adults == 0 ~ "None",
           n_biling_adults == 1 ~ "One Adult",
           n_biling_adults == 2 ~ "Two Adults",
           n_biling_adults > 2 ~ "Three or More Adults"
          )) %>% 
  mutate(n_biling_adults_group = as.factor(n_biling_adults_group)) 

adults_n$n_biling_adults_group <- factor(adults_n$n_biling_adults_group, levels = c("None", "One Adult", "Two Adults", "Three or More Adults"))

# # get proportion of bilingual adults per household
# adults_n <- adults_n %>% 
#   left_join(adults_biling_n, by = "household_id") %>% 
#   mutate(n_biling_adults = replace_na(n_biling_adults, 0), 
#          prop_biling_adults = n_biling_adults / n_adults,
#          
         # create factor for groups of # of bilingual adults


### education

# currently 8 factor levels. want to change to 5 to match Turcotte analyses. merging post-secondary levels together

hhdata_child_adult <- hhdata_child_adult %>% 
  mutate(education_rank = case_when(
    education == "No certificate, diploma or degree" ~ "No high school diploma",
    education == "Secondary (high) school diploma or equivalency certificate" ~ "High school diploma",
    education ==  "Trades certificate or diploma other than Certificate of Appr" |
    education ==  "Certificate of Apprenticeship or Certificate of Qualificatio" |
    education ==  "College, CEGEP or other non-university certificate or diplom" |
    education ==  "University certificate or diploma below bachelor level"  ~ "Post-secondary diploma",
    education == "Bachelor's degree" ~ "Bachelor's degree", 
    education == "University certificate, diploma or degree above bachelor lev" ~ "Graduate degree"
  ))

adults_edu <- hhdata_child_adult %>% 
  group_by(household_id) %>% 
  summarize(highest_ed = max(education_rank)) %>% 
  mutate(highest_ed = as.factor(highest_ed))

adults_edu$highest_ed <- factor(adults_edu$highest_ed, levels = c("No high school diploma", "High school diploma", "Post-secondary diploma", "Bachelor's degree", "Graduate degree"))


```


# create df for only children

```{r}
hhdata_child_only <- hhdata_child %>% 
  # filter for only children
  filter(child0_9 == 1) %>% 
  # join with # of bilingual adults
  left_join(adults_n, by = "household_id") %>% 
  # join with highest education
  left_join(adults_edu, by = "household_id") %>% 
  ### income - creating quintiles, following Turcotte analyses
  mutate(income_quintile = case_when(
    income_decile == "In first decile" | income_decile == "In second decile" ~ "In first quintile",
    income_decile == "In third decile" | income_decile == "In fourth decile" ~ "In second quintile",
    income_decile == "In fifth decile" | income_decile == "In sixth decile" ~ "In third quintile",
    income_decile == "In seventh decile" | income_decile == "In eighth decile" ~ "In fourth quintile",
    income_decile == "In ninth decile" | income_decile == "In tenth decile" ~ "In fifth quintile",
  )) %>% 
  mutate(income_quintile = as.factor(income_quintile))

hhdata_child_only$income_quintile <- factor(hhdata_child_only$income_quintile, levels = c("In first quintile", "In second quintile", "In third quintile", "In fourth quintile", "In fifth quintile"))
```


# exploratory data viz

## bilingal adults in household
```{r}
# number of bilingual children by number of bilingual adults in HH (HH without biling adults removed, so more detail can be seen)
hhdata_child_only %>% 
  filter(n_biling_adults != 0) %>% 
ggplot(aes(x = factor(n_biling_adults), fill = N_languages_person)) +
  geom_bar(position = "dodge")


# proportion of bilingual children in HH with various numbers of biling adults
ggplot(hhdata_child_only, aes(x = factor(n_biling_adults), fill = N_languages_person)) +
  geom_bar(position = "fill") +
  geom_abline(intercept = 0.5, slope = 0)

# grouped number of bilingual adults
ggplot(hhdata_child_only, aes(x = factor(n_biling_adults_group), fill = N_languages_person)) +
  geom_bar(position = "fill") +
  geom_abline(intercept = 0.5, slope = 0)



# number of bilingual children in HH with various proportion of bilingual adults
# ggplot(hhdata_child_only, aes(x = prop_biling_adults, fill = N_languages_person)) +
#   geom_histogram(binwidth = .1)
# 
# ## same but filtered for no bilingual adults
# hhdata_child_only %>% 
#   filter(n_biling_adults != 0) %>% 
#   ggplot(aes(x = prop_biling_adults, fill = N_languages_person)) +
#   geom_histogram(binwidth = .1)



## get total number of children in the database at number of bilinual adults
n_children_adults <- hhdata_child_only %>% 
  mutate(n_biling_adults = as.factor(n_biling_adults)) %>% 
  group_by(n_biling_adults) %>% 
  summarize(n_children_adults = n())

# percentage of bilingual children based on number of bilingual adults in their HH (O, 1, 2+)

biling_by_adults <- hhdata_child_only %>% 
  filter(N_languages_person_numeric > 1) %>% 
  mutate(n_biling_adults = as.factor(n_biling_adults)) %>% 
  group_by(n_biling_adults) %>% 
  summarize(n_children = n()) %>% 
  left_join(n_children_adults, by = "n_biling_adults") %>% 
  mutate(percent_children = n_children/n_children_adults * 100)


## get total number of children in the database at each level
n_children_adults_group <- hhdata_child_only %>% 
  group_by(n_biling_adults_group) %>% 
  summarize(n_children_adults_group = n())

# percentage of bilingual children based on number of bilingual adults in their HH (O, 1, 2+)

biling_by_adults_group <- hhdata_child_only %>% 
  filter(N_languages_person_numeric > 1) %>% 
  group_by(n_biling_adults_group) %>% 
  summarize(n_children = n()) %>% 
  left_join(n_children_adults_group, by = "n_biling_adults_group") %>% 
  mutate(percent_children = n_children/n_children_adults_group * 100)

```

## province / cities

```{r}
# proportion of bilingual children by province
ggplot(hhdata_child_only, aes(x = province, fill = N_languages_person)) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 90))


ggplot(hhdata_child_only, aes(x = province, fill = N_languages_person)) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_grid(. ~ n_biling_adults)



# proportion of bilingual children in major cities
ggplot(hhdata_child_only, aes(x = area, fill = N_languages_person)) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 90))


## get total number of children in each province
n_children_province <- hhdata_child_only %>% 
  group_by(province) %>% 
  summarize(n_children_province = n())

# percentage of bilingual children per province based on number of bilingual adults in their HH (O, 1, 2+)

biling_by_adults_province <- hhdata_child_only %>% 
  filter(N_languages_person_numeric > 1) %>% 
  group_by(n_biling_adults_group, province) %>% 
  summarize(n_children = n()) %>% 
  left_join(n_children_province, by = "province") %>%
  mutate(percent_children = n_children/n_children_province * 100)

```

## parental ed

```{r}
ggplot(hhdata_child_only, aes(x = factor(highest_ed), fill = N_languages_person)) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 90))

# by province
ggplot(hhdata_child_only, aes(x = factor(province), fill = N_languages_person)) +
  geom_bar(position = "fill") +
  theme(axis.text.x = element_text(angle = 90))+
  facet_grid( . ~ highest_ed)


## get total number of children for each parental education level
n_children_edu <- hhdata_child_only %>% 
  group_by(highest_ed) %>% 
  summarize(n_children_edu = n())

# percentage of bilingual children based on highest education of parents

biling_by_edu <- hhdata_child_only %>% 
  filter(N_languages_person_numeric > 1) %>% 
  group_by(highest_ed) %>% 
  summarize(n_children = n()) %>% 
  left_join(n_children_edu, by = "highest_ed") %>%
  mutate(percent_children = n_children/n_children_edu * 100)

## get total number of children for each parental education level in each province
n_children_edu_province <- hhdata_child_only %>% 
  group_by(highest_ed, province) %>% 
  summarize(n_children_edu_province = n())

# percentage of bilingual children based on highest education of parents by province
biling_by_edu_province <- hhdata_child_only %>% 
  filter(N_languages_person_numeric > 1) %>% 
  group_by(highest_ed, province) %>% 
  summarize(n_children = n()) %>% 
  left_join(n_children_edu_province, by = c("highest_ed", "province")) %>%
  mutate(percent_children = n_children/n_children_edu_province * 100)

```

## immigration status

```{r}
ggplot(hhdata_child_only, aes(x = immigration_generation, fill = N_languages_person)) +
  geom_bar(position = "fill") 
#+  theme(axis.text.x = element_text(angle = 90))


ggplot(hhdata_child_only, aes(x = immigration_generation, fill = N_languages_person)) +
  geom_bar(position = "fill") +
  facet_grid(. ~ province)


## get total number of children in each immigration generation
n_children_immigration <- hhdata_child_only %>% 
  group_by(immigration_generation) %>% 
  summarize(n_children_immigration = n())

# percentage of bilingual children per immigration generation

biling_by_immigration <- hhdata_child_only %>% 
  filter(N_languages_person_numeric > 1) %>% 
  group_by(immigration_generation) %>% 
  summarize(n_children = n()) %>% 
  left_join(n_children_immigration, by = "immigration_generation") %>%
  mutate(percent_children = n_children/n_children_immigration * 100)


## get total number of children for each immigration generation in each province
n_children_immigration_province <- hhdata_child_only %>% 
  group_by(immigration_generation, province) %>% 
  summarize(n_children_immigration_province = n())

# percentage of bilingual children based on immigration generation by province
biling_by_immigration_province <- hhdata_child_only %>% 
  filter(N_languages_person_numeric > 1) %>% 
  group_by(immigration_generation, province) %>% 
  summarize(n_children = n()) %>% 
  left_join(n_children_immigration_province, by = c("immigration_generation", "province")) %>%
  mutate(percent_children = n_children/n_children_immigration_province * 100)

```

## gender

```{r}
ggplot(hhdata_child_only, aes(x = sex, fill = N_languages_person)) +
  geom_bar(position = "fill") 
```

## income

```{r} 
ggplot(hhdata_child_only, aes(x = income_decile, fill = N_languages_person)) +
  geom_bar(position = "fill") 

ggplot(hhdata_child_only, aes(x = income_quintile, fill = N_languages_person)) +
  geom_bar(position = "fill")

## get total number of children in each income decile
n_children_income <- hhdata_child_only %>% 
  group_by(income_decile) %>% 
  summarize(n_children_income = n())

# percentage of bilingual children per immigration generation

biling_by_income <- hhdata_child_only %>% 
  filter(N_languages_person_numeric > 1) %>% 
  group_by(income_decile) %>% 
  summarize(n_children = n()) %>% 
  left_join(n_children_income, by = "income_decile") %>%
  mutate(percent_children = n_children/n_children_income * 100)
```


##### MODELS #####

# select and transform relevant variables


```{r}

hhdata_model <- hhdata_child_only %>% 
  select(person_id, household_id, N_languages_person, province, n_biling_adults_group, highest_ed, income_quintile, immigration_generation) %>% 
  mutate(N_languages_person = as.factor(N_languages_person),
         immigration_generation = na_if(immigration_generation, "Not available"),
         immigration_generation = factor(immigration_generation),
         child_biling = case_when(
           N_languages_person == "One Language" ~ 0,
           N_languages_person == "Two or more" ~ 1
         )) 


# # sum code variables  
# contrasts(hhdata_model$n_biling_adults_group) <- contr.sum(4)
# contrasts(hhdata_model$highest_ed) <- contr.sum(5)
# contrasts(hhdata_model$income_quintile) <- contr.sum(5)
# contrasts(hhdata_model$immigration_generation) <- contr.sum(4)

# reverse difference code variables
## allows for comparison of mean of given level to mean of previous level; level 1 as intercept

## manually create contrast matrices
contr_diff_3 <- matrix(c(-2/3, 1/3, 1/3, -1/3, -1/3, 2/3), ncol = 2)

contr_diff_4  <-  matrix(c(-3/4, 1/4, 1/4, 1/4, -1/2, -1/2, 1/2, 1/2, -1/4, -1/4, -1/4, 3/4), ncol = 3)

contr_diff_5 <- matrix(c(-4/5, 1/5, 1/5, 1/5, 1/5, -3/5, -3/5, 2/5, 2/5, 2/5, -2/5, -2/5, -2/5, 3/5, 3/5, -1/5, -1/5, -1/5, -1/5, 4/5), ncol = 4)

contrasts(hhdata_model$n_biling_adults_group) <- contr_diff_4
contrasts(hhdata_model$highest_ed) <- contr_diff_5
contrasts(hhdata_model$income_quintile) <- contr_diff_5
contrasts(hhdata_model$immigration_generation) <- contr_diff_4

# filter for only quebec data
hhdata_model_quebec <- hhdata_model %>% 
  filter(province == "Quebec")

# filter for Rest of Canada data  
hhdata_model_roc <- hhdata_model %>% 
  filter(province != "Quebec")


# create exposed df - only those children with at least 1 bilingual adult, because we need to redo contrasts when "none" level is removed

hhdata_model_exp <- hhdata_model %>% 
  filter(n_biling_adults_group != "None") %>% 
  mutate(n_biling_adults_group = factor(n_biling_adults_group))

contrasts(hhdata_model_exp$n_biling_adults_group) <- contr_diff_3

# filter for only quebec data
hhdata_model_quebec_exp <- hhdata_model_exp %>% 
  filter(province == "Quebec")

# filter for Rest of Canada data  
hhdata_model_roc_exp <- hhdata_model_exp %>% 
  filter(province != "Quebec")
```

## RoC model

```{r}
m_roc_all <- glm(child_biling ~ n_biling_adults_group + highest_ed + income_quintile + immigration_generation, data = hhdata_model_roc, family = "binomial")

summary(m_roc_all)


## interpreting summaries for sum coding - coefficients are difference between level and GRAND MEAN, last level of each predictor not included in model


# model for only those children who have at least 1 bilingual adult

m_roc_exp <- glm(child_biling ~ n_biling_adults_group + highest_ed + income_quintile + immigration_generation, data = hhdata_model_roc_exp, family = "binomial")

summary(m_roc_exp)
```

## Quebec model

```{r}
m_quebec_all <- glm(child_biling ~ n_biling_adults_group + highest_ed + income_quintile + immigration_generation, data = hhdata_model_quebec, family = "binomial")

summary(m_quebec_all)



# model for only those children who have at least 1 bilingual adult

m_quebec_exp <- glm(child_biling ~ n_biling_adults_group + highest_ed + income_quintile + immigration_generation, data = hhdata_model_quebec_exp, family = "binomial")

summary(m_quebec_exp)
```

## Classification accuracies

```{r}
# function
# lrAcc <- function(lrMod, responseVar, use.ranef=TRUE){
#   if(!is.factor(model.frame(lrMod)[,responseVar])){ model.frame(lrMod)[,responseVar] <- as.factor(model.frame(lrMod)[,responseVar]) }
#   if(use.ranef){ preds = predict(lrMod, newdata=model.frame(lrMod)) } else{ 
#     preds = predict(lrMod, newdata=model.frame(lrMod), re.form=NA) }
#   preds <- ((sign(preds)/2)+0.5)
#   respVarValues <- model.frame(lrMod)[,responseVar] 
#   if(is.numeric(respVarValues)){ y <- respVarValues } else{ 
#     y <- (as.numeric(model.frame(lrMod)[,responseVar])-1) }
#   acc <- sum(preds==y)/length(preds)
#   return(acc)
# }
# 
# 
# # calculate accuracies
# lrAcc(m_roc_all, as.factor("child_biling")) #87.51%
# lrAcc(m_roc_exp, as.factor("child_biling")) #58.77%
# lrAcc(m_quebec_all, as.factor("child_biling")) #89.68%
# lrAcc(m_quebec_exp, as.factor("child_biling")) #63.26%

```

## predicted probabilities

```{r}
# function to convert logit space to probabilities
logit2prob <- function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}

# steps for creating predictions
## 1. create df with all possible combinations of levels of variables
## 2. predict values for each combination
## 3. convert predicted values from logits to probabilities
## 4. average across levels of a single predictor



## 1. create df with all possible combinations of levels of variables

### for all children
newdata_all <- with(hhdata_model, expand.grid(n_biling_adults_group = unique(n_biling_adults_group),
                                              highest_ed = unique(highest_ed),
                                              income_quintile = unique(income_quintile),
                                              immigration_generation = unique(immigration_generation)))

### for only bilingually exposed children
newdata_exp <- with(hhdata_model_exp, expand.grid(n_biling_adults_group = unique(n_biling_adults_group),
                                              highest_ed = unique(highest_ed),
                                              income_quintile = unique(income_quintile),
                                              immigration_generation = unique(immigration_generation)))

## 2. predict values for each combination

# ROC all
newdata_all$prediction <- predict(m_roc_all, newdata=newdata_all)
roc_all <- newdata_all

# Quebec all
newdata_all$prediction <- predict(m_quebec_all, newdata=newdata_all)
quebec_all <- newdata_all


# ROC exposed
newdata_exp$prediction <- predict(m_roc_exp, newdata=newdata_exp)
roc_exp <- newdata_exp

# Quebec exposed
newdata_exp$prediction <- predict(m_quebec_exp, newdata=newdata_exp)
quebec_exp <- newdata_exp


## 3. convert predicted values from logits to probabilities using logit2prob function
## 4. average across levels of a single predictor

### function to do steps 3 and 4 
prob_pred <- function(pred){
  pred <- pred %>%
    filter(!is.na(prediction)) %>% 
    mutate(probability = logit2prob(prediction))
  
  adults <- pred %>% 
    group_by(n_biling_adults_group) %>% 
    summarize(mean_prob = mean(probability)) %>% 
    rename(predictor = n_biling_adults_group)
  
  edu <- pred %>% 
    group_by(highest_ed) %>% 
    summarize(mean_prob = mean(probability)) %>% 
    rename(predictor = highest_ed)
  
  income <- pred %>% 
    group_by(income_quintile) %>% 
    summarize(mean_prob = mean(probability)) %>% 
    rename(predictor = income_quintile)
  
  immigration <- pred %>% 
    group_by(immigration_generation) %>% 
    summarize(mean_prob = mean(probability)) %>% 
    rename(predictor = immigration_generation)
  
  rbind(adults, edu, income, immigration)
}

### apply function to each of the 4 models
roc_all_prob <- prob_pred(roc_all)
roc_exp_prob <- prob_pred(roc_exp)
quebec_all_prob <- prob_pred(quebec_all)
quebec_exp_prob <- prob_pred(quebec_exp)


```

## actual percentages

```{r}
# get the actual percentage of bilingual kids at each predictor level

biling_pct <- function(hhdata_df){
  
  adults <- hhdata_df %>% 
    group_by(child_biling, n_biling_adults_group) %>% 
    summarize(n = n()) %>% 
    pivot_wider(names_from = child_biling, values_from = n) %>% 
    rename(predictor = n_biling_adults_group, monolingual = `0`, bilingual = `1`) %>% 
    filter(!is.na(predictor)) %>% 
    mutate(total_n = monolingual + bilingual,
           biling_pct = bilingual / total_n * 100) %>% 
    select(predictor, biling_pct)
  
  edu <- hhdata_df %>% 
    group_by(child_biling, highest_ed) %>% 
    summarize(n = n()) %>% 
    pivot_wider(names_from = child_biling, values_from = n) %>% 
    rename(predictor = highest_ed, monolingual = `0`, bilingual = `1`) %>% 
    filter(!is.na(predictor)) %>% 
    mutate(total_n = monolingual + bilingual,
           biling_pct = bilingual / total_n * 100) %>% 
    select(predictor, biling_pct)

  
  income <- hhdata_df %>% 
    group_by(child_biling, income_quintile) %>% 
    summarize(n = n()) %>% 
    pivot_wider(names_from = child_biling, values_from = n) %>% 
    rename(predictor = income_quintile, monolingual = `0`, bilingual = `1`) %>% 
    filter(!is.na(predictor)) %>% 
    mutate(total_n = monolingual + bilingual,
           biling_pct = bilingual / total_n * 100) %>% 
    select(predictor, biling_pct)

  
  immigration <- hhdata_df %>% 
    group_by(child_biling, immigration_generation) %>% 
    summarize(n = n()) %>% 
    pivot_wider(names_from = child_biling, values_from = n) %>% 
    rename(predictor = immigration_generation, monolingual = `0`, bilingual = `1`) %>% 
    filter(!is.na(predictor)) %>% 
    mutate(total_n = monolingual + bilingual,
           biling_pct = bilingual / total_n * 100) %>% 
    select(predictor, biling_pct)

  
  rbind(adults, edu, income, immigration) 

}

roc_all_pct <- biling_pct(hhdata_model_roc)
roc_exp_pct <- biling_pct(hhdata_model_roc_exp)
quebec_all_pct <- biling_pct(hhdata_model_quebec)
quebec_exp_pct <- biling_pct(hhdata_model_quebec_exp)




```

## reshape data for tables for manuscript

```{r}

## actual percentage data
roc_all_table <- roc_all_pct %>% 
  rename(`Rest of Canada` = biling_pct)
roc_exp_table <- roc_exp_pct %>% 
  rename(`Rest of Canada (bilingually-exposed)` = biling_pct)
quebec_all_table <- quebec_all_pct %>% 
  rename(`Quebec` = biling_pct)
quebec_exp_table <- quebec_exp_pct %>% 
  rename(`Quebec (bilingually-exposed)` = biling_pct)

table_pct <- roc_all_table %>% 
  left_join(quebec_all_table, by = "predictor") %>%
  left_join(roc_exp_table, by = "predictor") %>% 
  left_join(quebec_exp_table, by = "predictor") %>% 
  mutate_if(is.numeric, round, 2) %>% 
  add_row(predictor = "Immigration generation", .before = 15) %>% 
  add_row(predictor = "Income quintile", .before = 10) %>% 
  add_row(predictor = "Highest level of parental education", .before = 5) %>% 
  add_row(predictor = "Number of bilingual adults in the household", .before = 1) %>% 
  rename(Characteristic = predictor)

write_csv(table_pct, here("03_output/Table-Percent-Multilingual-By-Characteristic.csv"))


## predction data
roc_all_table <- roc_all_prob %>% 
  rename(`Rest of Canada` = mean_prob)
roc_exp_table <- roc_exp_prob %>% 
  rename(`Rest of Canada (bilingually-exposed)` = mean_prob)
quebec_all_table <- quebec_all_prob %>% 
  rename(`Quebec` = mean_prob)
quebec_exp_table <- quebec_exp_prob %>% 
  rename(`Quebec (bilingually-exposed)` = mean_prob)

table_prob <- roc_all_table %>% 
  left_join(quebec_all_table, by = "predictor") %>%
  left_join(roc_exp_table, by = "predictor") %>% 
  left_join(quebec_exp_table, by = "predictor") %>% 
  mutate_if(is.numeric, round, 2) %>% 
  add_row(predictor = "Immigration generation", .before = 15) %>% 
  add_row(predictor = "Income quintile", .before = 10) %>% 
  add_row(predictor = "Highest level of parental education", .before = 5) %>% 
  add_row(predictor = "Number of bilingual adults in the household", .before = 1) %>% 
  rename(Characteristic = predictor)

write_csv(table_prob, here("03_output/Table-Probabilities.csv"))
```

