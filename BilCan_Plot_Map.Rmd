---
title: "Bilingualism in Canada: Geographic Distribution"
author: Esther Schott (esther.schott@mail.concordia.ca)
output: html_document
---
output: 
  html_document: 
    code_folding: show
    collapsed: no
    df_print: kable
    highlight: espresso
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load libraries
```{r}
#install.packages("gpclib", type="source")

library(tidyverse)
library(rgeos)
library(rgdal)
library(maptools)
library(sp)
library(here)
library(fuzzyjoin)
library(viridis)
library(scales)
library(ggrepel)
```


# load map data
## census cma map data
```{r}


# decent, uncluttered map theme (needs devtools package tho)
devtools::source_gist("https://gist.github.com/hrbrmstr/33baa3a79c5cfef0f6df")

if(!file.exists(here("02_map_data","census_map_2016","lcma000a16a_e.shp"))) {
# grab the file from "Statistics Canada"
# 2016 census, CMA areas only
download.file("http://www12.statcan.gc.ca/census-recensement/2011/geo/bound-limit/files-fichiers/2016/lcma000a16a_e.zip", destfile=here("02_map_data/census_map_2016.zip"))
unzip(here("02_map_data/census_map_2016.zip"))
system("ogr2ogr canada.shp lcma000a16a_e.shp -simplify 0.01")
}
canada2016 <- readOGR(here("02_map_data","census_map_2016","lcma000a16a_e.shp"),"lcma000a16a_e")





# do this to see what's available from an "identifier" standpoint
# "CDNAME" seems to be the census district name
# "PRNAME" seems to be the province name
# str(canada@data)




map_areas2016 <- data.frame(id=canada2016@data$CMANAME,
                        area=sapply(slot(canada2016, "polygons"), slot, "area") )
cma_map2016 <- fortify(canada2016, region="CMANAME")
rm(canada2016)
canada_map_areas_2016 <- merge(cma_map2016, map_areas2016, by="id")




```
## read census province map
```{r}
if(!file.exists(here("02_map_data","province_map_2016","lpr_000b16a_e.shp"))) {
download.file("http://www12.statcan.gc.ca/census-recensement/2011/geo/bound-limit/files-fichiers/2016/lpr_000b16a_e.zip", destfile=here("02_map_data/lpr_000a16a_e.zip"))
#download.file("http://www12.statcan.gc.ca/census-recensement/2011/geo/bound-limit/files-fichiers/2016/lpr_000a16a_e.zip",
 #             destfile=here("02_map_data/lpr_000a16a_e.zip"))

unzip(here("02_map_data/lpr_000a16a_e.zip"), exdir = here("02_map_data","province_map_2016"))


# this simplifies the polygons so they load/plot faster
system("ogr2ogr  lpr_000b16a_e.shp -simplify 0.01")
}

# what layers do we have? you can use this to check
#   ogrListLayers(here("02_map_data","province_map_2016","lpr_000b16a_e.shp"))
# but there are none, so the shapefile is the layer

province2016 <- readOGR(here("02_map_data","province_map_2016","lpr_000b16a_e.shp"),"lpr_000b16a_e")
province_map <- fortify(province2016, region="PRENAME")
rm(province2016)



```


# process census language data
## load census language data
```{r}
idata_child = readRDS(file = here::here("01_datasets","02_processed_data", "Individuals_child_data.rdata"))

```

## summarize census language data by CMA & province
```{r}
gma_LangGroup_data = idata_child %>%
  group_by(PR,CMA,N_Two_or_more) %>%
  summarize(N=n()) %>%
    mutate( Percent = round(N/sum(N),3))%>% 
    filter(N_Two_or_more != "1") 
    

```

## process "other" non-cma area data
```{r}

province_data = gma_LangGroup_data %>%    filter(substr(CMA,1,5) == "Other")

province_data$PR= as.character(province_data$PR)

northern_data = data.frame(PR= rep("Northern Canada",3), id = c("Yukon", "Northwest Territories", "Nunavut"))

province_data  = province_data %>% full_join(northern_data) %>%
  mutate(id = ifelse(is.na(id), as.character(PR), as.character(id)))

```

## match cma data to map data
```{r}
# remove "other" areas (saved in province_data)
gma_LangGroup_data = gma_LangGroup_data %>% 
   filter(substr(CMA,1,5) != "Other")

# try matching the census CMA names to the census map data
attempted_matching = stringdist_left_join(gma_LangGroup_data, 
                             map_areas2016 %>% 
                               rename(CMA = id), 
                             by ="CMA", 
                             distance_col = NULL)

# write failures to file to match by hand
attempted_matching %>% select(PR,CMA.x, CMA.y) %>% 
  # keep only those where matching failed
  filter(is.na(CMA.y)) %>% 
  # write to file to match by hand
  write.csv(., file=here("02_map_data/Dict-CMA.csv"), row.names=F) 

# read in the matched-by-hand-codes
dict.map  = read.csv(here("02_map_data/Dict-CMA-coded.csv"))

# add the hand-coded labels to the dataframe
gma_LangGroup_data = gma_LangGroup_data %>% 
  left_join(dict.map) %>% 
  rename(CMA.old = CMA) %>% 
  mutate(CMA = ifelse(is.na(CMA.splitUp), CMA.old, as.character(CMA.splitUp))) %>%
  select(-CMA.old, -CMA.splitUp)

# 
gma_lang_for_merging = gma_LangGroup_data %>% 
    stringdist_left_join(map_areas2016 %>% rename(CMA = id), 
                         by = "CMA", distance_col = NULL) %>% 
    select(-CMA.old, -CMA.x, -area) %>%
    rename(id = CMA.y)
```
# merge census data and map data
## CMAs
```{r}
gma_map_data = left_join(gma_lang_for_merging, canada_map_areas_2016)

```

## province data
```{r}

```

## get labels

```{r}
gma_labels = gma_map_data %>% filter(N>70) %>% group_by(CMA.old) %>% summarize(
  # y
  long = max(long), 
  # x 
  lat = mean(lat))


gma_labels_adj = gma_labels %>%
  mutate(city = ifelse(CMA.old == "Ottawa â€“ Gatineau", "Ottawa", CMA.old ),
    long_adj = case_when(
    city %in% c("Toronto", "Edmonton","Calgary", "Ottawa")~ long + 100000,
    TRUE ~ long),
    lat_adj  = ifelse(city == "Vancouver", lat - 150000, lat)
  )
```


# plot CMA and provinces together
```{r}
province_map_data = province_map_data %>% na.omit()
 ggplot() + 
  # draw province map
  geom_map(data=province_data , 
           map=province_map,
           aes(map_id=id, fill = Percent),
           color="white", 
        
           size=0.1)+ 
  # draw cma areas
geom_map(data=gma_map_data, 
        map=canada_map_areas_2016,
       aes(map_id=id,    
          group=id, 
         fill=Percent),
         color="white", 
        size=0.05)+ 
   scale_fill_viridis(option = "C", labels = percent, name="Rate of \nChild \nBilingualism")+
  # define limits for the plot (since province_map and canada_map_areas uses same scale, can use either one...)
   expand_limits(x = province_map$long, 
                 y = province_map$lat) + theme_map()+ coord_fixed(ratio=1)+
   geom_label_repel( aes(long, lat,label = city, group=NULL),
              size=5,
           data = gma_labels_adj) + 
   theme(legend.position = c(0.8, 0.5))
 ggsave(here::here("03_output","01_figures","canada_map.png"), width = 13, height =7)
```



