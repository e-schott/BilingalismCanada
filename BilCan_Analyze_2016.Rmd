---
title: "Census Bilingualism Analysis"
output: html_notebook
---
author: Esther Schott
please email esther.schott@mail.concordia.ca if you have any questions
see poster created from this script: https://osf.io/4gekn/

# 1. Preparation Steps
## 1.1. load packages
```{r echo=FALSE}
library(tidyverse)
library(foreign) # for reading in SPSS files
library(cowplot)
library(viridis)
library(janitor)

# for map stuff
library(rworldmap)
library(ggmap)
library(rgdal)
library(maps)
library(scales)
# for circle plots
# install.packages("packcircles")
library(packcircles)
```

## 1.2. function necessary to read in stuff
see https://dadoseteorias.wordpress.com/2017/04/29/read-spss-duplicated-levels/
for more info
```{r}
Int2Factor <- function(x)
{
    if(!is.null(attr(x, "value.labels"))){
        vlab <- attr(x, "value.labels")
        if(sum(duplicated(vlab)) > 0)
            cat("Duplicated levels:", vlab, "\n")
        else if(sum(duplicated(names(vlab))) > 0)
            cat("Duplicated labels:",
                names(vlab)[duplicated(names(vlab))], "\n")
        else
            x <- factor(x, levels = as.numeric(vlab),
                        labels = names(vlab))
    }
    x
}


```


## 2.0. individuals file preparation

### 2.0.1. read in invididuals file

```{r}




# 2016 data files
if(!exists("raw_idata")) {
raw_idata = read.spss("01_datasets/pumf-98M0001-E-2016-individuals_F1.sav", 
                      to.data.frame = T, 
                      use.value.labels = F)}


# convert strings to factors 
idata <- lapply(raw_idata, 
                    Int2Factor)
# convert list to dataframe
idata <- as.data.frame(idata, 
                           stringsAsFactors = FALSE)

# select which variables are necessary for our analysis
variables.keep = c("PPSORT", # individual case ID
  "PR","CMA", # location: province & metropolitain area
                   "AGEGRP","PKID0_1", "PKID2_5", # number of children between 0 and 1, and 2 and 5
                   "HLAEN","HLAFR","HLANO", # home language part A
                   "HLBEN","HLBFR","HLBNO") #home language part B

idata_short = idata %>% select(variables.keep)
idata_short$Child0_1 = factor(idata_short$PKID0_1, labels=c("NotAvailable","1+","0"))
idata_short$Child2_5 = factor(idata_short$PKID2_5, labels=c("NotAvailable","1+","0"))

# create adult variable... 
idata_short$adult = ifelse(as.integer(idata_short$AGEGRP)<16, "adult","child")

idata_short = idata_short %>%
  rename(caseID = "PPSORT")


```
### 2.0.2. change factor levels & variable names for language variables

```{r}



# change factor levels for part a (most often)
idata_short$HLA_En = factor(idata_short$HLAEN, labels= c(NA,T,F))
levels(idata_short$HLA_En) <- list(NotAvailable = NA,English = "TRUE",N="FALSE")
levels(idata_short$HLA_En)[levels(idata_short$HLA_En)=='NotAvailable'] <- NA


idata_short$HLA_Fr = factor(idata_short$HLAFR, labels= c(NA,T,F))
levels(idata_short$HLA_Fr) <- list(NotAvailable =NA, French = "TRUE",N="FALSE")
levels(idata_short$HLA_Fr)[levels(idata_short$HLA_Fr)=='NotAvailable'] <- NA


idata_short$HLA_Oth = factor(idata_short$HLANO)
levels(idata_short$HLA_Oth)[levels(idata_short$HLA_Oth)=='No non-official language'] <- "N"
levels(idata_short$HLA_Oth)[levels(idata_short$HLA_Oth)== 'Not available'] <- NA

levels(idata_short$HLA_Oth)[levels(idata_short$HLA_Oth)=='All other languages'] <- "Other"

# change for question part b (regular use)
idata_short$HLB_En = factor(idata_short$HLBEN, labels= c(NA, T,F))
levels(idata_short$HLB_En) <- list(NotAvailable =NA, English = "TRUE",N="FALSE")
levels(idata_short$HLB_En)[levels(idata_short$HLB_En)=='NotAvailable'] <- NA

idata_short$HLB_Fr = factor(idata_short$HLBFR, labels= c(NA,T,F))
levels(idata_short$HLB_Fr) <- list(NotAvailable =NA, French = "TRUE",N="FALSE")
levels(idata_short$HLB_Fr)[levels(idata_short$HLB_Fr)=='NotAvailable'] <- NA


idata_short$HLB_Oth = factor(idata_short$HLBNO, labels = c(T, F))
levels(idata_short$HLB_Oth) <- list(Other = "TRUE",N="FALSE")
#levels(idata_short$HLB_Oth)[levels(idata_short$HLB_Oth)=='N'] <- NA


```

### convert from wide to long
```{r}
old_language_cols = c("HLAEN","HLAFR", "HLANO","HLBEN",  "HLBFR", "HLBNO" )
idata_long = idata_short %>% 
  select(-old_language_cols) %>%
  # cut down size of df for debugging
  sample_n(193000) %>%

  gather(lang_question, answer,HLA_En:HLB_Oth) %>%
  arrange(caseID)


```

# create bilingualism variable (wide df)
```{r}
idata_long = idata_long %>%
 mutate(language_reported = if_else(answer =="N",0,1)) %>%
  group_by(caseID) %>%
  mutate(N_Lang = sum(language_reported, na.rm=T),
         N_Two_or_more = case_when(
                                  N_Lang == 1 ~ "1",
                                  N_Lang >1 ~ "2+",
                                  is.na(N_Lang) ~ NA_character_),
        # Lang_Combo_ranked = paste(answer[language_reported==1], 
        #                           collapse ="_"),
        # Lang_Combo_a_z = paste(sort(answer[language_reported==1]), 
        #                        collapse ="_"),
         Lang_Combo_top2 = paste(sort(answer[language_reported==1][1:2]), 
                                 collapse ="_")) 

idata_long = idata_long %>% ungroup()
# idata_long %>% filter(N_Lang>1) %>% View()

```

# get back to one-case-one-row
```{r}
idata_wide = idata_long %>% select(-lang_question, -answer, -language_reported) %>%
  distinct()
```



### 2.0.4. geographical location
```{r}
idata_long$gma.interest = ifelse(idata_long$CMA %in% c("Vancouver", "Montréal", "Toronto","Ottawa - Gatineau" , "Calgary", "Edmonton"),as.character(idata_long$CMA), NA)
```
 # individuals dataset: Children under 5
```{r}
idata_child = idata_wide %>%
  filter(AGEGRP == "0 to 4 years")


idata_child %>% 
  group_by(N_Two_or_more) %>%
  summarize(N=n()) %>%
  spread(N_Two_or_more, N) %>%
  clean_names() %>%
  mutate(total = x1+x2, 
         percent = x2/total)



```
 

# save idata_child for creating map


```{r}
saveRDS(idata_child, file = here::here("01_datasets","02_processed_data", "Individuals_child_data.rdata"))

  
#gma_LangGroup_data = gma_LangGroup_data %>% 
#  mutate(Area = agrep()

```




# 2. Individuals dataset: adults living with children under 5
## 2.1.dataset description
### 2.1.1. summary tables: children across canada
check how distributions over province and metropolitain areas are
```{r}
# select only adults who are living with at least one child
idata_hh_child = idata_wide %>% 
  filter(PKID0_1 =="One or more" | PKID2_5 =="One or more") %>% 
  filter(adult=="adult")

# how many are there per province & area?
idata_hh_child %>% group_by(PR, CMA) %>%
  summarize(N=n()) %>% 
  spread(PR, N)

# breakdown by province
idata_child %>% group_by(PR) %>%
  summarize(N=n())

# some provinces have  few data points. can probably concentrate on BC, Alberta, Ontario, Quebec



# top metropolitain areas
idata_child %>% group_by(CMA) %>%
   summarize(N=n()) %>%
  arrange(-N)
# top metropolitain areas are: Toronto, Montréal, Vancouver Calgary, Ottawa - Gatineau, Edmonton (cutoff could be 5000 individuals?)

```
## 2.2. bilingualism in children in individuals dataset
### 2.2.1. summary table: bilingual children across canada

```{r}
idata_short %>% filter(adult == "child") %>%
  group_by(AGEGRP, LangGroup_individual) %>%
  summarize(N=n()) %>%
  spread(LangGroup_individual, N) %>%
  clean_names() %>%
  mutate(total = one_language+two_or_more, percent = two_or_more/total)


```

### 2.2.2 summary tables: bilingual children under 6yo by province & metropolitan area
```{r}
idata_short %>% filter(AGEGRP == "0 to 4 years"| AGEGRP =="5 to 6 years") %>%
  group_by(gma.interest, LangGroup_individual) %>%
  summarize(N=n()) %>%
  spread(LangGroup_individual, N) %>%
  clean_names() %>%
  mutate(total = one_language+two_or_more, percent = round(two_or_more/total,3)) 

```


## 2.3. summary tables: number of bilingual adults living with a child under 5

```{r}


idata_child %>%
  filter(Child0_1 == "1+"  ) %>%
  group_by(LangGroup_individual) %>%
  summarize(Count = n())%>%
  mutate(           Percent = Count/sum(Count))

# broken down by key metropolotain areas

idata_child %>%
  filter(!is.na(gma.interest)& Child0_1 == "1+" |Child2_5=="1+") %>%
  group_by( gma.interest, LangGroup_individual) %>%
  summarize(Count = n())%>%
  mutate(           Percent = Count/sum(Count)) 
  


# need to investigate what to do with these NA in other language
idata_child %>% filter(is.na(LangGroup)) %>% 
  group_by(LangPair_simplified) %>% 
  summarize(count=n())

# look at 2-5 year olds
idata_child %>% 
  filter(Child2_5 == "1+") %>%
  group_by(LangGroupBil) %>%
  summarize(Count = n())  %>%
  mutate(           Percent = Count/sum(Count))

# these look relatively the same as the one-year olds, focus on the one-year olds becuase they are our population of interest and 2-5 year olds likely get more exposure outside of the house (not captured in this survey)
```


#3.  Households dataset
## 3.1. read in dataset & data cleaning
```{r}
# need to change to reading in factor solution as above
raw_hdata = read.spss("01_datasets/NHS-99M002X-E-2011-pumf-hierarchical_F1.sav",to.data.frame=T, use.value.labels = F)


# convert strings to factors 
raw_hdata <- lapply(raw_hdata, Int2Factor)
# convert list to dataframe
raw_hdata <- as.data.frame(raw_hdata, stringsAsFactors = FALSE)

# select which variables are necessary for our analysis
variables.hkeep = c("HH_ID","PP_ID",
  "PR","CMA", # location: province & metropolitain area
                   "AGEGRP",  # age of person
                   "HLAEN","HLAFR","HLANO", # home language part A
                   "HLBEN","HLBFR","HLBNO") #home language part B
hdata_short = raw_hdata %>% select(variables.hkeep)

```

## 3.2. look at only households with children 9 and under

```{r}
# create a variable that says whether child younger than 10 lives in household


hdata_short = hdata_short %>% 
  mutate(Child0_9 = ifelse(AGEGRP == "0 to 9 years", 1,0)) %>%
    group_by(HH_ID) %>%
  mutate(Child0_9_sum = sum(Child0_9))

```

## 3.3. refactor  language variables for easier coding
```{r}
## please note: I am using a hack here where I convert all of the "No" answers to NA - makes it much easier to count how many languages are observed overall and makes it easier to combine the languages to get language combinations. not ideal if we want to report number of missing values???


# change factor levels for part a (most often)
hdata_short$HLA_En = factor(hdata_short$HLAEN, labels= c(T,F))
levels(hdata_short$HLA_En) <- list(English = "TRUE",N="FALSE")
levels(hdata_short$HLA_En)[levels(hdata_short$HLA_En)=='N'] <- NA


hdata_short$HLA_Fr = factor(hdata_short$HLAFR, labels= c(T,F))
levels(hdata_short$HLA_Fr) <- list(French = "TRUE",N="FALSE")
levels(hdata_short$HLA_Fr)[levels(hdata_short$HLA_Fr)=='N'] <- NA


hdata_short$HLA_Oth = factor(hdata_short$HLANO)
levels(hdata_short$HLA_Oth)[levels(hdata_short$HLA_Oth)=='No non-official language'] <- NA
levels(hdata_short$HLA_Oth)[levels(hdata_short$HLA_Oth)=='All other single languages'] <- "other"

# change for question part b (regular use)
hdata_short$HLB_En = factor(hdata_short$HLBEN, labels= c(T,F))
levels(hdata_short$HLB_En) <- list(English = "TRUE",N="FALSE")
levels(hdata_short$HLB_En)[levels(hdata_short$HLB_En)=='N'] <- NA

hdata_short$HLB_Fr = factor(hdata_short$HLBFR, labels= c(T,F))
levels(hdata_short$HLB_Fr) <- list(French = "TRUE",N="FALSE")
levels(hdata_short$HLB_Fr)[levels(hdata_short$HLB_Fr)=='N'] <- NA


hdata_short$HLB_Oth = factor(hdata_short$HLBNO, labels = c(T, F))
levels(hdata_short$HLB_Oth) <- list(other = "TRUE",N="FALSE")
levels(hdata_short$HLB_Oth)[levels(hdata_short$HLB_Oth)=='N'] <- NA



```
###3.3.1. Create bilingualism variables (N languages, language pairs)

```{r}

# this takes a while to run! there are probably more efficient versions of this.. 
hdata_short = hdata_short %>%
  # calculate number of columns that are not NA out of the 6 language variables
mutate(Nlang_individual = rowSums(!is.na(data.frame(HLA_En, HLA_Fr, HLA_Oth, HLB_En, HLB_Fr, HLB_Oth))),
       # paste together information about the language pairs observed
  LangPair_individual = apply(data.frame(HLA_En, HLB_En, HLA_Fr, HLB_Fr, HLA_Oth, HLB_Oth), 1, function(x) paste(x[!is.na(x)], collapse = "_"))) %>%
  mutate(LangGroup_individual = 
           case_when(Nlang_individual == 0 ~ NA_character_,
                     Nlang_individual == 1 ~ "One Language",
                     Nlang_individual > 1 ~ "Two or more",
                     TRUE ~ NA_character_))

# minor cleaning steps for simplifying plotting
# subsume all trilinguals who speak English and French + X as English-French bilinguals
hdata_short$LangPair_isimplified = ifelse(substr(hdata_short$LangPair_individual,1,14 )=="English_French", "English_French", hdata_short$LangPair_individual)

# simplify bilinguals who speak two "other" languages - for ease of plotting
hdata_short$LangPair_isimplified  = gsub("other_other", "other", hdata_short$LangPair_isimplified)


```




## 3.4. summary tables: children under 9 years
```{r}
 
hdata_child = hdata_short %>%
  filter(Child0_9_sum >0)

# number of bilinguals
#canadian average:
hdata_child %>%
filter(AGEGRP=="0 to 9 years") %>%
  group_by(LangGroup_individual) %>%
  summarize(N=n()) %>%
    mutate( Percent = N/sum(N)) 





(gma_LangGroup_data = hdata_child %>%
filter(AGEGRP=="0 to 9 years") %>%
  group_by(PR,CMA,LangGroup_individual) %>%
  summarize(N=n()) %>%
    mutate( Percent = round(N/sum(N),3))%>%
    filter(LangGroup_individual != "One Language"))


# specific language combos
hdata_child_langPair = hdata_child %>% 
  filter(AGEGRP=="0 to 9 years",Nlang_individual>1 ) %>%
  group_by(PR,LangPair_isimplified) %>%
  summarize(N=n())%>%
  mutate( Percent = round(N/sum(N),3))%>%
  arrange(PR, -N)

hdata_child_langPair=hdata_child_langPair %>% group_by(PR) %>%
  slice(1:5) %>%
  mutate(id=seq_along(Percent))

# add nicer language labels to graph
dict = read.csv(file= "LangPair_Dict.csv")
hdata_child_langPair = full_join(hdata_child_langPair, dict)


```


